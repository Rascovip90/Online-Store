<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>متجر إلكتروني</title>
<style>
:root{
  --bg:#fff; --text:#000; --muted:#666; --accent:#ef4444; --green:#25D366;
  --card:#fff; --border:#e5e7eb; --control-border:#111;
}
*{box-sizing:border-box}
body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:120;padding:12px;background:var(--bg);border-bottom:2px solid var(--border);text-align:center;font-weight:900}
nav{display:flex;gap:12px;justify-content:center;padding:10px;background:var(--bg);border-bottom:1px solid var(--border)}
nav a{padding:8px 14px;border-radius:10px;text-decoration:none;color:var(--text);font-weight:700;border:2.5px solid transparent;cursor:pointer;transition:all .18s}
nav a.active{border-color:var(--accent)}
main{max-width:1000px;margin:18px auto;padding:10px}
.section-title{font-size:16px;margin:6px 0;font-weight:800}
.grid{display:grid;gap:14px;grid-template-columns:repeat(auto-fill,minmax(170px,1fr))}
.card{background:var(--card);border-radius:12px;padding:12px;border:1.5px solid var(--border);text-align:center;position:relative}
.card img{width:100%;height:110px;object-fit:cover;border-radius:8px;cursor:pointer}
.card h4{margin:8px 0 6px;font-size:14px}
.card p.desc{font-size:12px;color:var(--muted);min-height:36px}
.card p.price{color:var(--accent);font-weight:800;margin:6px 0}
.btn-3d{background:linear-gradient(145deg,#eee,#fff);border:0;padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:800;box-shadow:3px 3px 8px rgba(0,0,0,.08)}
.badge-new{position:absolute;top:8px;left:8px;background:transparent;color:var(--accent);padding:4px 6px;border-radius:6px;border:1px solid var(--accent);font-weight:800;font-size:11px}

.order-sticker{position:fixed;left:18px;bottom:22px;width:68px;height:68px;background:var(--card);border-radius:14px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid var(--border);cursor:pointer;z-index:800}
.order-sticker .icon{font-size:22px}
.sticker-count{position:absolute;top:8px;right:8px;background:var(--accent);color:#fff;border-radius:999px;padding:4px 7px;font-weight:900;display:none}

.cart-side{position:fixed;left:0;top:0;height:100vh;width:0;overflow:hidden;z-index:900;background:var(--card);border-top-right-radius:14px;border-bottom-right-radius:14px;transition:width .28s;border-right:2px solid var(--border);display:flex;flex-direction:column}
.cart-side.open{width:320px}
.cart-side .head{padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.cart-side .title{font-weight:900}
.cart-side .close-btn{background:transparent;border:0;color:var(--accent);font-size:18px;cursor:pointer}
.cart-side .content{padding:12px;flex:1;overflow:auto}
.cart-side .item{display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.cart-side .item img{width:48px;height:48px;object-fit:cover;border-radius:6px}
.cart-side .meta .name{font-weight:800}
.cart-side .qty{display:flex;gap:6px;align-items:center}
.cart-side .qty button{background:#f1f1f1;border:0;padding:6px;border-radius:6px;cursor:pointer}
.cart-side .remove-btn{background:var(--accent);color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}

.img-viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1100;padding:18px;background:rgba(0,0,0,.6)}
.img-viewer .box{position:relative;max-width:900px;width:100%;display:flex;align-items:center;justify-content:center}
.viewer-img{max-width:100%;max-height:80vh;border-radius:8px}
.img-arrow{position:absolute;top:50%;transform:translateY(-50%);background:var(--card);border:0;border-radius:999px;width:44px;height:44px;font-size:22px;cursor:pointer;box-shadow:2px 6px 18px rgba(0,0,0,.14)}
.img-arrow.left{left:-24px}
.img-arrow.right{right:-24px}
.viewer-close{position:absolute;top:-12px;left:-12px;background:#fff;border-radius:8px;padding:6px;border:0;cursor:pointer}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;padding:12px}
.panel{width:720px;max-width:98%;background:var(--card);padding:12px;border-radius:12px;border:2px solid var(--control-border);box-shadow:0 10px 30px rgba(0,0,0,.08)}
.form-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
input[type="text"],input[type="number"],textarea,select{padding:8px;border-radius:8px;border:1px solid var(--border);flex:1;font-size:13px}
.small-btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:800}
.checkbox-list{max-height:200px;overflow:auto;border:1px dashed var(--border);padding:8px;border-radius:8px;background:#fafafa}
.toast{position:fixed;left:50%;top:90px;transform:translateX(-50%);display:none;padding:10px 14px;border-radius:8px;z-index:1400}
.toast.success{background:#e6ffed;border:1px solid #b7f0c6;color:#0b7a2e}
.toast.error{background:#ffecef;border:1px solid #f5c2c2;color:#9b1c1c}
@media (max-width:760px){
  .card img{height:100px}
  .img-arrow.left{left:6px}
  .img-arrow.right{right:6px}
  .panel{width:94%}
}
</style>
</head>
<body>

<header>متجر إلكتروني</header>
<nav>
  <a id="nav-home" data-page="home" class="active">الرئيسية</a>
  <a id="nav-offers" data-page="offers">العروض</a>
  <a id="nav-admin" data-page="admin">لوحة التحكم</a>
</nav>

<main>
  <section id="home" class="page active">
    <h2 class="section-title">المنتجات</h2>
    <div id="productsGrid" class="grid"></div>
  </section>

  <section id="offers" class="page" style="display:none">
    <h2 class="section-title">العروض</h2>
    <div id="offersGrid" class="grid"></div>
  </section>
</main>

<div class="order-sticker" id="orderSticker" title="عرض السلة">
  <div class="sticker-count" id="stickerCount">0</div>
  <div class="icon">🛒</div>
  <div class="label" style="font-weight:900;font-size:12px;margin-top:4px">السلة</div>
</div>

<div class="cart-side" id="cartSide" aria-hidden="true">
  <div class="head">
    <div style="display:flex;gap:12px;align-items:center">
      <div class="title">سلة المشتريات</div>
      <div style="margin-left:12px;color:var(--muted)" id="sideTotalHead">0.00 ر.ع</div>
    </div>
    <div><button class="close-btn" id="closeCartBtn" aria-label="إغلاق">✖</button></div>
  </div>
  <div class="content" id="sideContent"><div id="sideItems"></div></div>
  <div class="footer" id="sideFooter"></div>
</div>

<div class="img-viewer" id="imgViewer" aria-hidden="true">
  <div class="box">
    <button id="viewerPrev" class="img-arrow left" aria-label="السابق">&#8592;</button>
    <img id="viewerImg" class="viewer-img" src="" alt="صورة">
    <button id="viewerNext" class="img-arrow right" aria-label="التالي">&#8594;</button>
    <button id="viewerClose" class="viewer-close" aria-label="إغلاق">✖</button>
  </div>
</div>

<div class="modal" id="adminModal" aria-hidden="true">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900">لوحة التحكم</div>
      <div><button class="small-btn" id="closeAdmin">إغلاق</button></div>
    </div>

    <div id="loginPanel" style="margin-top:10px">
      <div class="form-row">
        <input id="adminPass" type="password" placeholder="أدخل كلمة المرور">
        <button class="small-btn" id="adminLoginBtn">دخول</button>
      </div>
    </div>

    <div id="controlPanel" style="display:none;margin-top:12px">
      <h4 style="margin:6px 0 8px">إضافة / تعديل منتج</h4>
      <div class="form-row">
        <input id="prodName" placeholder="اسم المنتج">
        <input id="prodPrice" type="number" placeholder="السعر">
      </div>
      <div class="form-row">
        <input id="prodImages" placeholder="روابط الصور مفصولة بفاصلة (حتى 8 روابط)">
      </div>
      <div class="form-row">
        <textarea id="prodDesc" placeholder="الوصف (اختياري)"></textarea>
      </div>
      <div class="form-row" style="margin-top:8px">
        <select id="prodType"><option value="normal">رئيسية</option><option value="offer">عرض</option></select>
        <button class="small-btn" id="saveProdBtn">حفظ المنتج</button>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)">

      <h4 style="margin:6px 0 8px">إضافة عرض (اجمع منتجات رئيسية)</h4>
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px">اختر المنتجات التي تريد وضعها في العرض:</div>
      <div id="productsCheckboxes" class="checkbox-list" aria-live="polite">جارٍ التحميل...</div>

      <div class="form-row" style="margin-top:8px">
        <input id="offerName" placeholder="اسم العرض (مثال: باقة 2+1)">
        <input id="offerPrice" type="number" placeholder="السعر الجديد">
      </div>
      <div class="form-row">
        <input id="offerImages" placeholder="روابط صور العرض مفصولة بفاصلة (اختياري)">
      </div>
      <div class="form-row" style="margin-top:8px">
        <textarea id="offerDesc" placeholder="وصف العرض (اختياري)"></textarea>
      </div>
      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="small-btn" id="saveOfferBtn">حفظ العرض</button>
        <button id="clearSelectionBtn" class="btn-3d">مسح الاختيارات</button>
      </div>

      <hr style="margin:12px 0;border:none;border-top:1px solid var(--border)">

      <h4 style="margin:6px 0 8px">قائمة العروض الحالية</h4>
      <div id="adminOffersList" style="max-height:180px;overflow:auto"></div>

      <h4 style="margin:10px 0 6px">قائمة المنتجات الحالية</h4>
      <div id="adminProductsList" class="admin-list" style="max-height:180px;overflow:auto"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const SUPABASE_URL = "https://tkyiakteuwsmhokfmxtd.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRreWlha3RldXdzbWhva2ZteHRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5Mzg2ODQsImV4cCI6MjA3MDUxNDY4NH0.b_UTIODNRo3o0iNEKQzGHvR4fZ1MOnQm36iPClcPAvM";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, { auth: { persistSession: false } });

const navLinks = document.querySelectorAll('nav a');
const pages = document.querySelectorAll('.page');
const productsGrid = document.getElementById('productsGrid');
const offersGrid = document.getElementById('offersGrid');
const orderSticker = document.getElementById('orderSticker');
const stickerCount = document.getElementById('stickerCount');
const cartSide = document.getElementById('cartSide');
const sideItems = document.getElementById('sideItems');
const sideTotalHead = document.getElementById('sideTotalHead');
const closeCartBtn = document.getElementById('closeCartBtn');
const imgViewer = document.getElementById('imgViewer');
const viewerImg = document.getElementById('viewerImg');
const viewerPrev = document.getElementById('viewerPrev');
const viewerNext = document.getElementById('viewerNext');
const viewerClose = document.getElementById('viewerClose');
const adminModal = document.getElementById('adminModal');
const adminLoginBtn = document.getElementById('adminLoginBtn');
const adminPassInput = document.getElementById('adminPass');
const closeAdminBtn = document.getElementById('closeAdmin');
const controlPanel = document.getElementById('controlPanel');
const loginPanel = document.getElementById('loginPanel');
const productsCheckboxes = document.getElementById('productsCheckboxes');
const saveOfferBtn = document.getElementById('saveOfferBtn');
const clearSelectionBtn = document.getElementById('clearSelectionBtn');
const adminProductsList = document.getElementById('adminProductsList');
const adminOffersList = document.getElementById('adminOffersList');
const saveProdBtn = document.getElementById('saveProdBtn');
const prodNameInput = document.getElementById('prodName');
const prodPriceInput = document.getElementById('prodPrice');
const prodImagesInput = document.getElementById('prodImages');
const prodDescInput = document.getElementById('prodDesc');
const prodTypeSelect = document.getElementById('prodType');
const offerNameInput = document.getElementById('offerName');
const offerPriceInput = document.getElementById('offerPrice');
const offerImagesInput = document.getElementById('offerImages');
const offerDescInput = document.getElementById('offerDesc');
const toastEl = document.getElementById('toast');

let products = [];
let offers = [];
let productsMap = {};
let cart = JSON.parse(localStorage.getItem('cart_v2') || '[]');

function showToast(text, type = 'success', ms = 3000) {
  toastEl.textContent = text;
  toastEl.className = 'toast ' + (type === 'success' ? 'success' : 'error');
  toastEl.style.display = 'block';
  setTimeout(() => toastEl.style.display = 'none', ms);
}
function parseDbImagesField(field) {
  if (!field) return [];
  if (Array.isArray(field)) return field;
  if (typeof field === 'string') {
    const trimmed = field.trim();
    if (trimmed.startsWith('{') && trimmed.endsWith('}')) {
      const inner = trimmed.slice(1, -1);
      return inner.split(',').map(s => s.trim()).filter(Boolean);
    }
    return trimmed.split(',').map(s => s.trim()).filter(Boolean);
  }
  return [];
}
function saveCartLocal() {
  localStorage.setItem('cart_v2', JSON.stringify(cart));
  updateSticker();
}
function updateSticker() {
  const cnt = cart.reduce((s,i)=>s + (i.qty||0), 0);
  stickerCount.textContent = cnt;
  stickerCount.style.display = cnt ? 'block' : 'none';
}
navLinks.forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    navLinks.forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    pages.forEach(p => p.classList.remove('active'));
    const target = a.dataset.page;
    const el = document.getElementById(target);
    if (el) el.classList.add('active');
  });
});

async function loadProductsFromDB() {
  try {
    const { data, error } = await supabase.from('products').select('*').order('id', { ascending: true });
    if (error) throw error;
    products = (data || []).map(p => ({
      id: p.id,
      name: p.name,
      price: Number(p.price) || 0,
      description: p.description || p.desc || '',
      images: parseDbImagesField(p.images),
      raw: p
    }));
    productsMap = {};
    products.forEach(p => productsMap[p.id] = p);
    renderProductsGrid();
    fillProductsCheckboxes();
    renderAdminProductsList();
  } catch (err) {
    console.error('loadProductsFromDB', err);
    showToast('فشل جلب المنتجات', 'error', 3500);
  }
}
async function loadOffersFromDB() {
  try {
    const { data, error } = await supabase.from('offers').select('*').order('id', { ascending: true });
    if (error) throw error;
    offers = (data || []).map(o => ({
      id: o.id,
      name: o.name,
      price: Number(o.price) || 0,
      description: o.description || '',
      images: parseDbImagesField(o.images),
      products_ids: Array.isArray(o.products_ids) ? o.products_ids : (o.products_ids ? (String(o.products_ids).split(',').map(x=>Number(x.trim()))) : []),
      raw: o
    }));
    renderOffersGrid();
    renderAdminOffersList();
  } catch (err) {
    console.error('loadOffersFromDB', err);
    showToast('فشل جلب العروض', 'error', 3500);
  }
}
function renderProductsGrid() {
  productsGrid.innerHTML = '';
  products.forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      ${ (Date.now() - (p.raw && p.raw.created_at ? new Date(p.raw.created_at).getTime() : Date.now())) < 12*3600*1000 ? '<div class="badge-new">NEW</div>' : '' }
      <img src="${p.images[0] || ''}" alt="${escapeHtml(p.name)}" data-id="${p.id}" class="prod-main-img">
      <h4>${escapeHtml(p.name)}</h4>
      <p class="desc">${escapeHtml(p.description)}</p>
      <p class="price">${Number(p.price).toFixed(2)} ر.ع</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button class="btn-3d add-prod" data-id="${p.id}">أضف للسلة</button>
        <button class="btn-3d view-prod" data-id="${p.id}">عرض الصور</button>
      </div>
    `;
    productsGrid.appendChild(card);
  });
  document.querySelectorAll('.add-prod').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = Number(e.currentTarget.dataset.id);
      addToCart('product', id, 1);
    });
  });
  document.querySelectorAll('.view-prod').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = Number(e.currentTarget.dataset.id);
      const prod = productsMap[id];
      if (!prod) return;
      openViewer(prod.images, 0);
    });
  });
  document.querySelectorAll('.prod-main-img').forEach(img=>{
    img.addEventListener('click', e=>{
      const id = Number(e.currentTarget.dataset.id);
      const prod = productsMap[id];
      if (!prod) return;
      openViewer(prod.images, 0);
    });
  });
}
function renderOffersGrid() {
  offersGrid.innerHTML = '';
  offers.forEach(o=>{
    const card = document.createElement('div');
    card.className = 'card';
    const firstImg = (o.images && o.images.length) ? o.images[0] : (o.products_ids && o.products_ids.length ? (productsMap[o.products_ids[0]] ? productsMap[o.products_ids[0]].images[0] : '') : '');
    const productsHtml = (o.products_ids || []).map(id=>escapeHtml(productsMap[id] ? productsMap[id].name : 'منتج')).join(' ، ');
    card.innerHTML = `
      <img src="${firstImg || ''}" alt="${escapeHtml(o.name)}" data-offer-id="${o.id}" class="offer-main-img">
      <h4>${escapeHtml(o.name)}</h4>
      <p class="desc">${escapeHtml(o.description)}</p>
      <p class="price">${Number(o.price).toFixed(2)} ر.ع</p>
      <p class="desc" style="font-size:12px;color:#444"><strong>المكونات:</strong> ${productsHtml}</p>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px">
        <button class="btn-3d add-offer" data-id="${o.id}">أضف للسلة</button>
        <button class="btn-3d view-offer" data-id="${o.id}">عرض الصور</button>
      </div>
    `;
    offersGrid.appendChild(card);
  });
  document.querySelectorAll('.add-offer').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = Number(e.currentTarget.dataset.id);
      addToCart('offer', id, 1);
    });
  });
  document.querySelectorAll('.view-offer').forEach(b=>{
    b.addEventListener('click', e=>{
      const id = Number(e.currentTarget.dataset.id);
      const offer = offers.find(x=>x.id===id);
      if (!offer) return;
      const imgs = offer.images.length ? offer.images : (offer.products_ids && offer.products_ids.length ? (productsMap[offer.products_ids[0]] ? productsMap[offer.products_ids[0]].images : []) : []);
      openViewer(imgs, 0);
    });
  });
  document.querySelectorAll('.offer-main-img').forEach(img=>{
    img.addEventListener('click', e=>{
      const id = Number(e.currentTarget.dataset.offerId);
      const offer = offers.find(x=>x.id===id);
      if (!offer) return;
      const imgs = offer.images.length ? offer.images : (offer.products_ids && offer.products_ids.length ? (productsMap[offer.products_ids[0]] ? productsMap[offer.products_ids[0]].images : []) : []);
      openViewer(imgs, 0);
    });
  });
}
function addToCart(type, id, qty = 1) {
  if (type === 'product') {
    const p = productsMap[id];
    if (!p) { showToast('المنتج غير موجود','error'); return; }
    const exist = cart.find(ci => ci.type==='product' && ci.id===id);
    if (exist) exist.qty += qty; else cart.push({ type:'product', id: p.id, name: p.name, price: p.price, image: p.images[0] || '', qty });
  } else if (type === 'offer') {
    const o = offers.find(x => x.id === id);
    if (!o) { showToast('العرض غير موجود','error'); return; }
    const exist = cart.find(ci => ci.type==='offer' && ci.id===id);
    if (exist) exist.qty += qty; else cart.push({ type:'offer', id: o.id, name: o.name, price: o.price, image: o.images[0] || (o.products_ids && o.products_ids[0] ? (productsMap[o.products_ids[0]] ? productsMap[o.products_ids[0]].images[0] : '') : ''), qty });
  }
  saveCartLocal();
  showToast('تمت الإضافة إلى السلة', 'success', 1200);
}
function renderCartSide() {
  sideItems.innerHTML = '';
  let total = 0;
  cart.forEach((ci, idx)=>{
    const row = document.createElement('div');
    row.className = 'item';
    const img = document.createElement('img'); img.src = ci.image || ''; img.alt = ci.name;
    const meta = document.createElement('div'); meta.className = 'meta';
    meta.innerHTML = `<div class="name">${escapeHtml(ci.name)}</div><div class="sub">${Number(ci.price).toFixed(2)} ر.ع</div>`;
    const qtyDiv = document.createElement('div'); qtyDiv.className = 'qty';
    const minus = document.createElement('button'); minus.textContent = '-'; minus.addEventListener('click', ()=>{ updateQtyAt(idx, -1); });
    const span = document.createElement('span'); span.textContent = ci.qty; span.style.minWidth = '18px'; span.style.textAlign = 'center';
    const plus = document.createElement('button'); plus.textContent = '+'; plus.addEventListener('click', ()=>{ updateQtyAt(idx, +1); });
    qtyDiv.appendChild(minus); qtyDiv.appendChild(span); qtyDiv.appendChild(plus);
    const removeBtn = document.createElement('button'); removeBtn.className = 'remove-btn'; removeBtn.textContent = 'حذف'; removeBtn.addEventListener('click', ()=>{ if(confirm('حذف من السلة؟')) { cart.splice(idx,1); saveCartLocal(); renderCartSide(); } });
    row.appendChild(img); row.appendChild(meta); row.appendChild(qtyDiv); row.appendChild(removeBtn);
    sideItems.appendChild(row);
    total += Number(ci.price) * ci.qty;
  });
  sideTotalHead.textContent = Number(total).toFixed(2) + ' ر.ع';
}
function updateQtyAt(idx, delta) {
  if (!cart[idx]) return;
  cart[idx].qty += delta;
  if (cart[idx].qty <= 0) cart.splice(idx,1);
  saveCartLocal();
  renderCartSide();
}
orderSticker.addEventListener('click', ()=>{
  cartSide.classList.add('open');
  cartSide.setAttribute('aria-hidden','false');
  renderCartSide();
});
closeCartBtn.addEventListener('click', ()=>{
  cartSide.classList.remove('open');
  cartSide.setAttribute('aria-hidden','true');
});
const buyBtn = document.createElement('button'); buyBtn.className='btn-3d'; buyBtn.textContent='اطلب الآن عبر واتساب'; buyBtn.style.width='100%'; buyBtn.style.marginTop='8px'; buyBtn.style.background='linear-gradient(145deg,var(--green),#19b857)'; buyBtn.style.color='#fff'; document.getElementById('sideFooter').appendChild(buyBtn);
buyBtn.addEventListener('click', function(){
  if (cart.length===0){ alert('السلة فارغة'); return; }
  let text = 'طلب من المتجر:\n';
  let total = 0;
  cart.forEach((ci,i)=>{ text += `${i+1}. ${ci.name} x ${ci.qty} = ${Number(ci.price*ci.qty).toFixed(2)} ر.ع\n`; total += ci.price*ci.qty; });
  text += `المجموع: ${Number(total).toFixed(2)} ر.ع`;
  const WHATSAPP_NUMBER = '96898586097';
  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(text)}`;
  window.open(url, '_blank');
});
let viewerImgs = [];
let viewerIndex = 0;
function openViewer(imgs = [], start=0) {
  viewerImgs = imgs || [];
  viewerIndex = start || 0;
  viewerImg.src = viewerImgs[viewerIndex] || '';
  imgViewer.style.display = 'flex';
  imgViewer.setAttribute('aria-hidden','false');
}
function closeViewer() {
  imgViewer.style.display = 'none';
  imgViewer.setAttribute('aria-hidden','true');
}
viewerPrev.addEventListener('click', ()=>{ if(viewerImgs.length===0) return; viewerIndex = (viewerIndex - 1 + viewerImgs.length) % viewerImgs.length; viewerImg.src = viewerImgs[viewerIndex] || ''; });
viewerNext.addEventListener('click', ()=>{ if(viewerImgs.length===0) return; viewerIndex = (viewerIndex + 1) % viewerImgs.length; viewerImg.src = viewerImgs[viewerIndex] || ''; });
viewerClose.addEventListener('click', closeViewer);
imgViewer.addEventListener('click', e => { if (e.target === imgViewer) closeViewer(); });

function fillProductsCheckboxes() {
  productsCheckboxes.innerHTML = '';
  if (!products.length) { productsCheckboxes.textContent = 'لا توجد منتجات حالياً.'; return; }
  products.forEach(p=>{
    const id = p.id;
    const row = document.createElement('label');
    row.style.display = 'block';
    row.style.padding = '6px';
    row.style.cursor = 'pointer';
    row.innerHTML = `<input type="checkbox" value="${id}"> <strong>${escapeHtml(p.name)}</strong> — ${Number(p.price).toFixed(2)} ر.ع`;
    productsCheckboxes.appendChild(row);
  });
}
saveOfferBtn.addEventListener('click', async ()=>{
  const checked = Array.from(productsCheckboxes.querySelectorAll('input[type="checkbox"]:checked')).map(i=>Number(i.value));
  const name = (offerNameInput.value || '').trim();
  const price = parseFloat(offerPriceInput.value);
  const desc = (offerDescInput.value || '').trim();
  const imagesRaw = (offerImagesInput.value || '').trim();
  const imgs = imagesRaw ? imagesRaw.split(',').map(s=>s.trim()).filter(Boolean) : [];
  if (!checked.length) { alert('اختر منتج واحد على الأقل ليكون ضمن العرض'); return; }
  if (!name || isNaN(price)) { alert('أدخل اسم العرض والسعر الجديد'); return; }
  try {
    const payload = { name, price: price, description: desc, images: imgs.length ? imgs : null, products_ids: checked };
    const { data, error } = await supabase.from('offers').insert([payload]);
    if (error) throw error;
    showToast('✅ تم حفظ العرض', 'success', 2000);
    await loadOffersFromDB();
    navLinks.forEach(a=>a.classList.remove('active'));
    const offersNav = document.querySelector('nav a[data-page="offers"]');
    if (offersNav) { offersNav.classList.add('active'); pages.forEach(p=>p.classList.remove('active')); const el = document.getElementById('offers'); if (el) el.classList.add('active'); }
    offerNameInput.value = ''; offerPriceInput.value = ''; offerDescInput.value = ''; offerImagesInput.value = '';
    productsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked = false);
  } catch (err) {
    console.error('saveOffer', err);
    showToast('❌ فشل حفظ العرض', 'error', 3000);
  }
});
clearSelectionBtn.addEventListener('click', ()=> { productsCheckboxes.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.checked = false); });

saveProdBtn.addEventListener('click', async ()=>{
  const name = (prodNameInput.value || '').trim();
  const price = parseFloat(prodPriceInput.value);
  const desc = (prodDescInput.value || '').trim();
  const imgs = (prodImagesInput.value || '').trim().split(',').map(s=>s.trim()).filter(Boolean).slice(0,8);
  const type = prodTypeSelect.value || 'normal';
  if (!name || isNaN(price) || !imgs.length) { alert('أدخل اسم، سعر، وصور (رابط واحد على الأقل)'); return; }
  try {
    const payload = { name, price, description: desc, images: imgs, type };
    const { data, error } = await supabase.from('products').insert([payload]);
    if (error) throw error;
    showToast('✅ تمت إضافة المنتج', 'success', 1600);
    prodNameInput.value = ''; prodPriceInput.value = ''; prodImagesInput.value = ''; prodDescInput.value = '';
    await loadProductsFromDB();
    await loadOffersFromDB();
  } catch (err) {
    console.error('save product', err);
    showToast('❌ فشل إضافة المنتج', 'error', 3000);
  }
});
async function renderAdminProductsList() {
  adminProductsList.innerHTML = '';
  if (!products.length) { adminProductsList.textContent = 'لا توجد منتجات.'; return; }
  products.forEach(p=>{
    const row = document.createElement('div');
    row.style.display = 'flex'; row.style.justifyContent = 'space-between'; row.style.alignItems = 'center';
    row.style.padding = '8px'; row.style.borderBottom = '1px solid #eee';
    row.innerHTML = `<div style="max-width:70%"><strong>${escapeHtml(p.name)}</strong><div style="color:#666">${Number(p.price).toFixed(2)} ر.ع</div></div>`;
    const actions = document.createElement('div');
    const edit = document.createElement('button'); edit.className = 'btn-3d'; edit.textContent = 'تعديل'; edit.style.marginRight = '6px';
    edit.addEventListener('click', ()=> editProduct(p.id));
    const del = document.createElement('button'); del.className = 'btn-3d'; del.textContent = 'حذف'; del.style.background = '#ef4444'; del.style.color = '#fff';
    del.addEventListener('click', ()=> deleteProductConfirm(p.id, p.name));
    actions.appendChild(edit); actions.appendChild(del);
    row.appendChild(actions);
    adminProductsList.appendChild(row);
  });
}
async function renderAdminOffersList() {
  adminOffersList.innerHTML = '';
  if (!offers.length) { adminOffersList.textContent = 'لا توجد عروض.'; return; }
  offers.forEach(o=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center';
    row.style.padding='8px'; row.style.borderBottom='1px solid #eee';
    row.innerHTML = `<div style="max-width:68%"><strong>${escapeHtml(o.name)}</strong><div style="color:#666">${Number(o.price).toFixed(2)} ر.ع</div></div>`;
    const actions = document.createElement('div');
    const del = document.createElement('button'); del.className='btn-3d'; del.textContent='حذف'; del.style.background='#ef4444'; del.style.color='#fff';
    del.addEventListener('click', ()=> deleteOfferConfirm(o.id, o.name));
    actions.appendChild(del);
    row.appendChild(actions);
    adminOffersList.appendChild(row);
  });
}
let editingProductId = null;
async function editProduct(id) {
  try {
    const { data, error } = await supabase.from('products').select('*').eq('id', id).single();
    if (error) throw error;
    const p = data;
    prodNameInput.value = p.name || '';
    prodPriceInput.value = p.price || '';
    prodDescInput.value = p.description || p.desc || '';
    prodImagesInput.value = Array.isArray(p.images) ? p.images.join(', ') : (p.images || '');
    prodTypeSelect.value = p.type || 'normal';
    editingProductId = id;
    saveProdBtn.textContent = 'حفظ التعديل';
    saveProdBtn.onclick = async function saveEditHandler() {
      const name = (prodNameInput.value || '').trim();
      const price = parseFloat(prodPriceInput.value);
      const desc = prodDescInput.value || '';
      const imgs = prodImagesInput.value.trim().split(',').map(s=>s.trim()).filter(Boolean).slice(0,8);
      if (!name || isNaN(price)) { alert('أدخل الاسم والسعر'); return; }
      try {
        const { error } = await supabase.from('products').update({ name, price, description: desc, images: imgs, type: prodTypeSelect.value }).eq('id', editingProductId);
        if (error) throw error;
        showToast('✅ تم تحديث المنتج', 'success', 1600);
        saveProdBtn.textContent = 'حفظ المنتج';
        saveProdBtn.onclick = null;
        editingProductId = null;
        prodNameInput.value=''; prodPriceInput.value=''; prodImagesInput.value=''; prodDescInput.value='';
        await loadProductsFromDB();
      } catch (err) {
        console.error('edit product',err);
        showToast('❌ فشل تحديث المنتج','error',3000);
      }
    };
  } catch (err) {
    console.error('editProduct', err);
    showToast('❌ فشل جلب بيانات المنتج','error',3000);
  }
}
async function deleteProductConfirm(id, name) {
  if (!confirm(`هل تريد حذف المنتج "${name}"؟`)) return;
  try {
    const { error } = await supabase.from('products').delete().eq('id', id);
    if (error) throw error;
    showToast('✅ تم الحذف', 'success', 1600);
    await loadProductsFromDB();
    await loadOffersFromDB();
  } catch (err) {
    console.error('deleteProduct', err);
    showToast('❌ فشل الحذف', 'error', 3000);
  }
}
async function deleteOfferConfirm(id, name) {
  if (!confirm(`هل تريد حذف العرض "${name}"؟`)) return;
  try {
    const { error } = await supabase.from('offers').delete().eq('id', id);
    if (error) throw error;
    showToast('✅ تم حذف العرض', 'success', 1600);
    await loadOffersFromDB();
  } catch (err) {
    console.error('deleteOffer', err);
    showToast('❌ فشل حذف العرض', 'error', 3000);
  }
}
document.getElementById('nav-admin').addEventListener('click',(e)=>{ e.preventDefault(); adminModal.style.display='flex'; adminModal.setAttribute('aria-hidden','false'); loginPanel.style.display = sessionStorage.getItem('adminAuth') === 'true' ? 'none' : 'block'; controlPanel.style.display = sessionStorage.getItem('adminAuth') === 'true' ? 'block' : 'none'; });
closeAdminBtn.addEventListener('click', ()=>{ adminModal.style.display='none'; adminModal.setAttribute('aria-hidden','true'); editingProductId = null; saveProdBtn.textContent = 'حفظ المنتج'; saveProdBtn.onclick = null; });
adminLoginBtn.addEventListener('click', ()=>{
  const pass = adminPassInput.value;
  if (pass === '7732') {
    sessionStorage.setItem('adminAuth','true');
    loginPanel.style.display = 'none';
    controlPanel.style.display = 'block';
    loadProductsFromDB();
    loadOffersFromDB();
  } else {
    alert('كلمة المرور خاطئة');
  }
});
async function initApp(){
  cart = (Array.isArray(cart) ? cart.filter(c=>c && c.id) : []);
  saveCartLocal();
  await loadProductsFromDB();
  await loadOffersFromDB();
  updateSticker();
}
initApp();
function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
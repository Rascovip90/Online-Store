<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…ØªØ¬Ø± Rasco 9 â€” Ù…ØªÙƒØ§Ù…Ù„ Ù…Ø¹ Supabase</title>
<style>
:root{
  --primary:#3b82f6; --primary-dark:#2563eb; --danger:#ef4444; --success:#25D366;
  --muted:#888; --card:#fff; --border:#e5e7eb; --bg:#fff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:Tahoma,Arial,Helvetica,sans-serif;background:var(--bg);color:#000}
header{position:sticky;top:0;z-index:120;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--card);border-bottom:2.5px solid var(--border)}
.logo .title{font-weight:900}
nav{display:flex;gap:12px;align-items:center}
nav a{padding:7px 14px;border-radius:10px;text-decoration:none;color:inherit;font-weight:700;cursor:pointer;border:2.7px solid transparent}
nav a.active{background:#f6f6f6;border-color:var(--danger)}
main{padding:14px;max-width:960px;margin:0 auto 100px;color:var(--text-main)}
.section-title{margin:6px 0 12px;font-size:16px;font-weight:700}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(152px,1fr));gap:14px}
.card{background:var(--card);border-radius:12px;padding:12px;border:1.5px solid var(--border);position:relative;text-align:center}
.card h4{margin:7px 0 4px;font-size:13px}
.card p.desc{font-size:10px;color:var(--muted);min-height:32px}
.card p.price{color:var(--danger);font-weight:800;margin:6px 0}
.add-btn{background:var(--primary);color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:800;font-size:12px}
.add-btn:hover{background:var(--primary-dark)}
.badge-new{position:absolute;top:7px;left:7px;padding:4px 6px;border-radius:6px;font-weight:800;font-size:10px;border:1px solid var(--danger);color:var(--danger)}
.order-sticker{position:fixed;left:18px;bottom:22px;width:65px;height:65px;background:var(--card);border-radius:15px;display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px solid var(--border);cursor:pointer;box-shadow:0 2px 12px rgba(0,0,0,0.07)}
.order-sticker .icon{font-size:22px}
.order-sticker .label{font-size:12px;font-weight:900;margin-top:4px}
.sticker-count{position:absolute;top:8px;right:8px;background:var(--danger);color:#fff;font-size:10px;padding:4px 6px;border-radius:999px;display:none;font-weight:900}
.cart-side{position:fixed;left:0;top:0;height:100vh;width:0;overflow:hidden;z-index:600;background:var(--card);border-top-right-radius:14px;border-bottom-right-radius:14px;transition:width .28s;display:flex;flex-direction:column;border-right:2px solid var(--primary)}
.cart-side.open{width:320px}
.cart-side .head{padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border)}
.cart-side .title{font-weight:900}
.cart-side .close-btn{background:transparent;border:none;font-size:18px;cursor:pointer;color:var(--danger)}
.cart-side .content{padding:10px;flex:1;overflow:auto}
.cart-side .item{display:flex;gap:9px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.cart-side .item img{width:48px;height:48px;object-fit:cover;border-radius:6px}
.cart-side .meta{flex:1;text-align:right}
.cart-side .qty{display:flex;gap:6px;align-items:center}
.cart-side .qty button{background:#eee;border:none;padding:4px 6px;border-radius:6px;cursor:pointer}
.cart-side .remove-btn{background:var(--danger);color:#fff;border:none;padding:4px 6px;border-radius:6px;cursor:pointer}
.cart-side .buy-btn{background:var(--success);color:#fff;border:none;padding:7px 10px;border-radius:8px;font-weight:900;cursor:pointer;position:relative}
.admin-list{margin-top:9px;max-height:220px;overflow:auto;border-top:1px solid var(--border);padding-top:6px}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;padding:14px}
.panel{width:496px;max-width:100%;background:var(--card);padding:12px;border-radius:10px;border:2.7px solid #111}
.form-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:7px}
input,textarea,select{padding:7px;border-radius:7px;border:1px solid var(--border);flex:1;font-size:13px}
.small-btn{background:var(--primary);color:#fff;padding:6px 9px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
.img-viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200}
.img-viewer img{max-width:100%;max-height:70vh;border-radius:6px}
.status{position:fixed;top:70px;left:50%;transform:translateX(-50%);background:#fff;padding:8px 12px;border-radius:8px;border:1px solid #eee;z-index:800;display:none}
@media (max-width:860px){.panel{width:90%}.cart-side.open{width:78%}}
</style>
</head>
<body>

<header>
  <div style="display:flex;gap:8px;align-items:center">
    <div class="logo" title="Ø§Ù„Ù…ØªØ¬Ø±"><div class="title">Ù…ØªØ¬Ø±<br>Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div></div>
  </div>
  <nav>
    <a id="nav-home" href="#home" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a id="nav-offers" href="#offers">Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
    <a id="nav-admin" href="#control">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
  </nav>
</header>

<main>
  <section id="home" style="display:block">
    <h2 class="section-title">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div id="productsGrid" class="grid"></div>
  </section>

  <section id="offers" style="display:none">
    <h2 class="section-title">Ø§Ù„Ø¹Ø±ÙˆØ¶</h2>
    <div id="offersGrid" class="grid"></div>
  </section>
</main>

<div class="status" id="statusBox" role="status"></div>

<div class="order-sticker" id="orderSticker" title="Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©">
  <div class="sticker-count" id="stickerCount">0</div>
  <div class="icon">ğŸ›’</div>
  <div class="label">Ø§Ù„Ø³Ù„Ø©</div>
</div>

<div class="cart-side" id="cartSide" aria-hidden="true">
  <div class="head">
    <div class="head-controls" style="display:flex;gap:10px;align-items:center">
      <div class="title">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
      <div class="total-row">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <strong id="sideTotalHead">0.00 Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ</strong></div>
      <button class="buy-btn" id="buyBtn">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
    </div>
    <div><button class="close-btn" id="closeCartBtn">âœ–</button></div>
  </div>
  <div class="content" id="sideContent"><div id="sideItems"></div></div>
  <div class="footer"></div>
</div>

<!-- Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± -->
<div class="img-viewer" id="imgViewer"><div style="position:relative;text-align:center;"><img id="viewerImg" src=""><button id="viewerClose" style="position:absolute;top:8px;left:8px;padding:6px;background:#fff;border-radius:6px;border:0;cursor:pointer;">âœ–</button></div></div>

<!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Ù…ÙˆØ¯Ø§Ù„) -->
<div class="modal" id="adminModal">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:900;font-size:15px">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div><button class="small-btn" onclick="closeAdmin()">âœ–</button></div>
    </div>

    <div id="loginPanel" class="form-row" style="margin-top:14px;display:flex;">
      <input id="adminPass" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button class="small-btn" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button>
    </div>

    <div id="controlPanel" style="display:none;margin-top:9px">
      <input type="hidden" id="editingId" value="">
      <div class="form-row">
        <input id="prodName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input id="prodPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
      </div>
      <div class="form-row">
        <input id="prodImages" placeholder="Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ø­ØªÙ‰ 4)">
      </div>
      <div class="form-row">
        <textarea id="prodDesc" placeholder="Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      </div>
      <div class="form-row">
        <select id="prodType">
          <option value="normal">Ø±Ø¦ÙŠØ³ÙŠØ©</option>
          <option value="offer">Ø¹Ø±Ø¶</option>
        </select>
        <button class="small-btn" id="saveProductBtn">Ø¥Ø¶Ø§ÙØ©</button>
      </div>

      <div style="margin-top:9px"><strong>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</strong></div>
      <div class="admin-list" id="adminList"></div>
    </div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Supabase ========== */
const SUPABASE_URL = 'https://rqiognpfzyyfyferyjah.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxaW9nbnBmenl5ZnlmZXlqamhhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzI2ODcsImV4cCI6MjA3MDMwODY4N30.srA9q_fRyWo0d4htuiC4lyrBg2j5QSABfA1yi_8MSIc';

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
const ADMIN_PASS = '7732';
const WA_NUMBER = '77324648';
const PRODUCTS_KEY = 'my_products_v3';
const CART_KEY = 'my_cart_v3';

let products = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '[]');
let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');

/* Ø¹Ù†Ø§ØµØ± DOM */
const productsGrid = document.getElementById('productsGrid');
const offersGrid = document.getElementById('offersGrid');
const cartSide = document.getElementById('cartSide');
const sideItems = document.getElementById('sideItems');
const adminModal = document.getElementById('adminModal');
const loginPanel = document.getElementById('loginPanel');
const controlPanel = document.getElementById('controlPanel');
const adminListDiv = document.getElementById('adminList');
const imgViewer = document.getElementById('imgViewer');
const viewerImg = document.getElementById('viewerImg');
const viewerClose = document.getElementById('viewerClose');
const orderSticker = document.getElementById('orderSticker');
const stickerCountEl = document.getElementById('stickerCount');
const buyBtn = document.getElementById('buyBtn');
const saveProductBtn = document.getElementById('saveProductBtn');
const statusBox = document.getElementById('statusBox');

/* Ù…Ø³Ø§Ø¹Ø¯Ø© */
function showStatus(msg, isError=true){
  statusBox.textContent = msg;
  statusBox.style.display = 'block';
  statusBox.style.background = isError ? '#fff3f3' : '#f3fff7';
  statusBox.style.color = isError ? '#a00' : '#070';
  clearTimeout(showStatus._t);
  showStatus._t = setTimeout(()=>{ statusBox.style.display='none'; }, 6000);
}
function saveProductsLocal(){ localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products)); }
function saveCartLocal(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
function formatCurrency(v){ return Number(v).toFixed(2); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ========== Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ========== */
function renderProducts(){
  productsGrid.innerHTML = '';
  const now = Date.now();
  products.filter(p=>p.type==='normal').forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    const imgs = Array.isArray(p.images) ? p.images.slice(0,4) : [];
    const main = imgs[0]||'';
    card.innerHTML = `
      <div class="gallery">
        ${(now - (p.dateAdded||0) < 24*60*60*1000) ? '<div class="badge-new">NEW</div>' : ''}
        <img src="${escapeHtml(main)}" class="main-img" alt="${escapeHtml(p.name)}" data-id="${p.id}" data-index="0">
        <div class="thumbs">${imgs.map((u,i)=>`<img src="${escapeHtml(u)}" class="thumb ${i===0?'active':''}" data-id="${p.id}" data-index="${i}">`).join('')}</div>
      </div>
      <h4>${escapeHtml(p.name)}</h4>
      <p class="desc">${escapeHtml(p.desc||'')}</p>
      <p class="price">${formatCurrency(p.price)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ</p>
      <button class="add-btn" onclick="addToCartById(${p.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
    `;
    productsGrid.appendChild(card);
  });
  attachGalleryHandlers();
}

function renderOffers(){
  if(!offersGrid) return;
  offersGrid.innerHTML = '';
  const now = Date.now();
  products.filter(p=>p.type==='offer').forEach(p=>{
    const card = document.createElement('div'); card.className='card';
    const imgs = Array.isArray(p.images) ? p.images.slice(0,4) : [];
    const main = imgs[0]||'';
    card.innerHTML = `
      <div class="gallery">
        ${(now - (p.dateAdded||0) < 24*60*60*1000) ? '<div class="badge-new">NEW</div>' : ''}
        <img src="${escapeHtml(main)}" class="main-img" alt="${escapeHtml(p.name)}" data-id="${p.id}" data-index="0">
        <div class="thumbs">${imgs.map((u,i)=>`<img src="${escapeHtml(u)}" class="thumb ${i===0?'active':''}" data-id="${p.id}" data-index="${i}">`).join('')}</div>
      </div>
      <h4>${escapeHtml(p.name)}</h4>
      <p class="desc">${escapeHtml(p.desc||'')}</p>
      <p class="price">${formatCurrency(p.price)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ</p>
      <button class="add-btn" onclick="addToCartById(${p.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
    `;
    offersGrid.appendChild(card);
  });
  attachGalleryHandlers();
}

/* gallery handlers */
function attachGalleryHandlers(){
  document.querySelectorAll('.thumb').forEach(t=>{
    t.addEventListener('click',function(){
      const card=this.closest('.card');
      const main=card.querySelector('.main-img');
      card.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
      this.classList.add('active');
      main.classList.add('fade');
      setTimeout(()=>{ main.src = t.src; main.classList.remove('fade'); },180);
      main.dataset.index=this.dataset.index;
    });
  });
  document.querySelectorAll('.main-img').forEach(m=>{
    m.addEventListener('click',function(){
      const id=Number(this.dataset.id);
      const prod = products.find(p=>p.id===id);
      if(!prod) return;
      const imgs = Array.isArray(prod.images) && prod.images.length ? prod.images : [''];
      const start = Number(this.dataset.index||0);
      openViewer(imgs,start);
    });
  });
}
let viewerImgs=[], viewerIndex=0;
function openViewer(imgs,startIndex=0){ viewerImgs = imgs; viewerIndex = startIndex||0; viewerImg.src = viewerImgs[viewerIndex]||''; imgViewer.style.display='flex'; }
function closeViewer(){ imgViewer.style.display='none'; }
viewerClose.addEventListener('click', closeViewer);
imgViewer.addEventListener('click', e=>{ if(e.target===imgViewer) closeViewer(); });

/* ========== Ø§Ù„Ø³Ù„Ø© ========== */
function addToCartById(id){
  const product = products.find(p=>p.id===id);
  if(!product) return;
  const existing = cart.find(c=>c.id===id);
  if(existing) existing.qty += 1; else cart.push({id: product.id, qty:1});
  saveCartLocal(); renderCartViews(); updateSticker();
}
function updateQty(id,delta){
  const item = cart.find(c=>c.id===id); if(!item) return; item.qty += delta; if(item.qty<=0) cart = cart.filter(c=>c.id!==id); saveCartLocal(); renderCartViews();
}
function removeFromCart(id){ cart = cart.filter(c=>c.id!==id); saveCartLocal(); renderCartViews(); updateSticker(); }
function renderCartViews(){
  sideItems.innerHTML = ''; let total=0;
  cart.forEach(ci=>{
    const p = products.find(x=>x.id===ci.id); if(!p) return;
    total += p.price * ci.qty;
    const item = document.createElement('div'); item.className='item';
    const imgSrc = (Array.isArray(p.images) && p.images.length) ? p.images[0] : '';
    item.innerHTML = `
      <img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(p.name)}">
      <div class="meta"><div class="name">${escapeHtml(p.name)}</div><div class="sub">${formatCurrency(p.price)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ Ã— ${ci.qty}</div></div>
      <div class="qty"><button onclick="updateQty(${p.id},-1)">-</button><span style="min-width:18px;text-align:center">${ci.qty}</span><button onclick="updateQty(${p.id},+1)">+</button></div>
      <div style="margin-left:6px"><button class="remove-btn" onclick="removeFromCart(${p.id})">Ø­Ø°Ù</button></div>
    `;
    sideItems.appendChild(item);
  });
  document.getElementById('sideTotalHead').textContent = formatCurrency(total) + ' Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ';
}
function updateSticker(){ const c = cart.reduce((s,i)=>s+i.qty,0); stickerCountEl.textContent = c; stickerCountEl.style.display = c ? 'block' : 'none'; }

/* open/close cart */
function openSideCart(){ cartSide.classList.add('open'); cartSide.setAttribute('aria-hidden','false'); }
function closeSideCart(){ cartSide.classList.remove('open'); cartSide.setAttribute('aria-hidden','true'); }
document.getElementById('closeCartBtn').addEventListener('click', closeSideCart);
orderSticker.addEventListener('click', openSideCart);

/* admin UI */
function openAdminModal(){ adminModal.style.display='flex'; loginPanel.style.display = sessionStorage.getItem('adminAuth')==='true' ? 'none' : 'flex'; controlPanel.style.display = sessionStorage.getItem('adminAuth')==='true' ? 'block' : 'none'; document.getElementById('adminPass').value=''; }
function closeAdmin(){ adminModal.style.display='none'; }
function adminLogin(){ const p = document.getElementById('adminPass').value; if(p===ADMIN_PASS){ sessionStorage.setItem('adminAuth','true'); loginPanel.style.display='none'; controlPanel.style.display='block'; loadAdminList(); } else alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'); }
document.getElementById('nav-admin').addEventListener('click', e=>{ e.preventDefault(); openAdminModal(); });

/* ========== Supabase: Ø¬Ù„Ø¨/Ø­ÙØ¸/Ø­Ø°Ù Ù…Ù†ØªØ¬Ø§Øª ========== */

/* Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª â€” ÙŠÙ‚Ø±Ø£ Ù…Ù† Ø§Ù„Ø¹Ù…ÙˆØ¯ names: id,name,price,images,description,type,date_added */
async function fetchProductsFromSupabase(){
  try{
    showStatus('Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...', false);
    const res = await sb.from('products').select('id,name,price,images,description,type,date_added').order('date_added',{ascending:false});
    if(res.error){
      console.error('Supabase fetch error:', res.error);
      showStatus('ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ' + (res.error.message||res.error), true);
      // fallback: use local
      products = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '[]');
    } else {
      const data = res.data || [];
      if(data.length === 0){
        showStatus('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.', true);
        products = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || '[]');
      } else {
        products = data.map(item => ({
          id: item.id,
          name: item.name || '',
          price: item.price ? Number(item.price) : 0,
          images: item.images ? String(item.images).split(',').map(s=>s.trim()).filter(s=>s) : [],
          desc: item.description || '',
          type: item.type || 'normal',
          dateAdded: item.date_added ? new Date(item.date_added).getTime() : Date.now()
        }));
        saveProductsLocal();
        showStatus('ØªÙ… Ø¬Ù„Ø¨ ' + products.length + ' Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….', false);
      }
    }
    // keep cart items valid
    cart = cart.filter(ci=>products.some(p=>p.id===ci.id));
    saveCartLocal();
    renderProducts(); renderOffers(); renderCartViews(); updateSticker();
  }catch(err){
    console.error('fetchProductsFromSupabase err', err);
    showStatus('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª.', true);
  }
}

/* Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªØ¬ */
async function saveProductToSupabase(payload, editingId=null){
  try{
    if(editingId){
      const res = await sb.from('products').update(payload).eq('id', Number(editingId)).select();
      if(res.error) throw res.error;
      return res.data && res.data[0];
    } else {
      const res = await sb.from('products').insert([payload]).select();
      if(res.error) throw res.error;
      return res.data && res.data[0];
    }
  }catch(err){
    console.error('saveProductToSupabase err', err);
    throw err;
  }
}

/* Ø­Ø°Ù Ù…Ù† Supabase */
async function deleteProductFromSupabase(id){
  try{
    const res = await sb.from('products').delete().eq('id', Number(id));
    if(res.error) throw res.error;
    return true;
  }catch(err){
    console.error('deleteProductFromSupabase err', err);
    throw err;
  }
}

/* handler Ø²Ø± Ø­ÙØ¸/Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ */
saveProductBtn.addEventListener('click', async function(){
  const name = document.getElementById('prodName').value.trim();
  const price = parseFloat(document.getElementById('prodPrice').value);
  const imagesRaw = document.getElementById('prodImages').value.trim();
  const desc = document.getElementById('prodDesc').value.trim();
  const type = document.getElementById('prodType').value || 'normal';
  const editingId = document.getElementById('editingId').value || null;

  if(!name || !imagesRaw || isNaN(price)){
    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØµÙˆØ± (Ø±ÙˆØ§Ø¨Ø·) ÙˆØ§Ù„Ø³Ø¹Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­');
    return;
  }

  const imgsArr = imagesRaw.split(',').map(s=>s.trim()).filter(s=>s).slice(0,4);
  const payload = {
    name: name,
    price: price,
    images: imgsArr.join(','),
    description: desc,
    type: type,
    date_added: new Date().toISOString()
  };

  try{
    showStatus(editingId ? 'Ø¬Ø§Ø±Ù ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬...' : 'Ø¬Ø§Ø±Ù Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ø®Ø§Ø¯Ù…...', false);
    await saveProductToSupabase(payload, editingId ? Number(editingId) : null);
    await fetchProductsFromSupabase();
    // reset form
    document.getElementById('prodName').value=''; document.getElementById('prodPrice').value=''; document.getElementById('prodImages').value=''; document.getElementById('prodDesc').value=''; document.getElementById('editingId').value=''; saveProductBtn.textContent='Ø¥Ø¶Ø§ÙØ©';
    loadAdminList();
    showStatus('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­.', false);
  }catch(err){
    showStatus('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ' + (err.message||err), true);
  }
});

/* ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© */
function loadAdminList(){
  adminListDiv.innerHTML = '';
  products.forEach(p=>{
    const row = document.createElement('div');
    row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.padding='6px 0';
    row.innerHTML = `<div style="max-width:70%"><strong>${escapeHtml(p.name)}</strong><br><small style="color:#333">${escapeHtml(p.desc||'')}</small></div>
      <div style="display:flex;gap:6px">
        <button class="small-btn" onclick="startEdit(${p.id})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button style="background:var(--danger);color:#fff;padding:6px 7px;border-radius:8px;border:0;cursor:pointer" onclick="confirmDelete(${p.id})">Ø­Ø°Ù</button>
      </div>`;
    adminListDiv.appendChild(row);
  });
}

/* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
function startEdit(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  sessionStorage.setItem('adminAuth','true'); loginPanel.style.display='none'; controlPanel.style.display='block';
  document.getElementById('prodName').value = p.name; document.getElementById('prodPrice').value = p.price;
  document.getElementById('prodImages').value = Array.isArray(p.images) ? p.images.join(', ') : (p.images || '');
  document.getElementById('prodDesc').value = p.desc || ''; document.getElementById('prodType').value = p.type || 'normal';
  document.getElementById('editingId').value = p.id; saveProductBtn.textContent='Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
}

/* ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù */
async function confirmDelete(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
  try{
    showStatus('Ø¬Ø§Ø±ÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬...', false);
    await deleteProductFromSupabase(id);
    await fetchProductsFromSupabase();
    loadAdminList();
    showStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.', false);
  }catch(err){
    showStatus('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬.', true);
  }
}

/* ========== Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ========== */
async function init(){
  saveCartLocal();
  await fetchProductsFromSupabase();
  loadAdminList();
}
init();

/* ========== Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ ========== */
buyBtn.addEventListener('click', function(){
  if(cart.length === 0){ alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); return; }
  let text = "Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£ÙˆØ¯ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡:\n---------------------\nØ§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\n";
  let total = 0;
  cart.forEach((ci, idx) => {
    const p = products.find(x => x.id === ci.id);
    if(!p) return;
    text += `${idx+1}. ${p.name} Ã— ${ci.qty} = ${formatCurrency(p.price * ci.qty)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ\n`;
    total += p.price * ci.qty;
  });
  text += "---------------------\n";
  text += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${formatCurrency(total)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ\n\n`;
  text += "ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±. Ø´ÙƒØ±Ù‹Ø§ Ù„ÙƒÙ…!";
  window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`, '_blank');
});

/* Ø§Ø®ØªØµØ§Ø±Ø§Øª */
document.addEventListener('keydown', function(e){
  if(e.key === 'Escape'){ if(imgViewer.style.display==='flex') closeViewer(); if(adminModal.style.display==='flex') closeAdmin(); }
});
</script>
</body>
</html>
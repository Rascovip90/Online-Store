<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Supabase)</title>
<style>
:root{
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --secondary: #fff;
  --background: #fff;
  --text-main: #000;
  --muted: #888;
  --danger: #ef4444;
  --success: #25D366;
  --card: #fff;
  --border: #e5e7eb;
  --active-bg: #f6f6f6;
  --control-border: #111;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Tahoma,Arial,Helvetica,sans-serif;
  background:var(--background);
  color:var(--text-main);
}
header{
  position:sticky; top:0; z-index:120;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 16px;
  background: var(--secondary);
}
.logo .title{ color:var(--text-main); font-weight:900; line-height:1;}
nav{
  display:flex; gap:12px; align-items:center; position:relative;
  min-height:50px;
  background: var(--secondary);
  border-bottom: 2.5px solid var(--border);
}
nav a{
  text-decoration:none;
  color:var(--text-main);
  padding:7px 16px;
  border-radius:11px;
  font-weight:700;
  cursor:pointer;
  background:none;
  position:relative;
  transition:background 0.19s, color 0.18s, border 0.19s;
  border:2.7px solid transparent;
}
nav a.active{
  background:var(--active-bg);
  color:var(--text-main);
  border:2.7px solid var(--danger);
}
nav a:not(.active):hover{background:var(--active-bg);}
main{ padding:14px; max-width:960px; margin:0 auto 100px auto; color:var(--text-main);}
.section-title{ margin:6px 0 12px; font-size:16px; font-weight:700; color:var(--text-main);}
.grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(152px,1fr)); gap:14px;}
.card{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  border:1.5px solid var(--border);
  position:relative; overflow:visible; text-align:center;
  color:var(--text-main);
}
.card h4{margin:7px 0 4px;font-size:13px;color:var(--text-main);}
.card p.desc{font-size:10px;color:var(--muted);min-height:32px;}
.card p.price{color:var(--danger);font-weight:800;margin:6px 0;}
.card .add-btn{
  background:var(--primary);
  color:#fff;
  border:0;padding:6px 10px;border-radius:8px;cursor:pointer;
  font-weight:800;font-size:12px;
  transition:background 0.18s;
}
.card .add-btn:hover{background:var(--primary-dark);}
.badge-new{
  position:absolute;top:7px;left:7px;
  background:transparent;
  color:var(--danger);
  padding:4px 6px;
  border-radius:6px;
  font-weight:800;font-size:10px;
  border:1px solid var(--danger);
}
.order-sticker{
  position:fixed;
  left:18px;
  bottom:22px;
  width:65px;height:65px;
  background:var(--secondary);
  border-radius:15px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  border:2px solid var(--border);
  cursor:pointer;
  color:var(--text-main);
  box-shadow:0 2px 12px rgba(0,0,0,0.07);
}
.order-sticker .icon{font-size:22px; color:var(--text-main);}
.order-sticker .label{font-size:12px;color:var(--text-main);font-weight:900;margin-top:4px;}
.sticker-count{
  position:absolute;
  top:8px;right:8px;
  background:var(--danger);
  color:#fff;
  font-size:10px;
  padding:4px 6px;
  border-radius:999px;
  display:none;
  font-weight:900;
}
.cart-side{
  position:fixed;left:0;top:0;height:100vh;width:0;overflow:hidden;z-index:600;
  background:var(--secondary);
  border-top-right-radius:14px;border-bottom-right-radius:14px;transition:width 0.28s;display:flex;flex-direction:column;
  border-right:2px solid var(--primary);
  color:var(--text-main);
  box-shadow: 0 6px 30px rgba(0,0,0,0.06);
}
.cart-side.open{width:320px;}
.cart-side .head{padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
.cart-side .title{font-weight:900;font-size:15px;color:var(--text-main);}
.cart-side .close-btn{background:transparent;border:none;font-size:18px;cursor:pointer;color:var(--danger);}
.cart-side .head-controls{display:flex;align-items:center;gap:10px;}
.cart-side .total-row{font-size:13px;color:var(--text-main);}
.cart-side .buy-btn{
  background:var(--success);
  color:#fff;border:none;padding:7px 10px;border-radius:8px;font-weight:900;cursor:pointer;
  font-size:12px;
  transition:background 0.18s;
  position:relative;
  box-shadow: 0 3px 8px #25d3662b;
}
.cart-side .buy-btn.blink{ animation: blinkBtn 0.7s alternate infinite; }
@keyframes blinkBtn { 0% {box-shadow:0 0 0 0px var(--danger);} 60% {box-shadow:0 0 0 14px var(--danger);} 100% {box-shadow:0 0 0 0px var(--danger);} }
.buy-btn-indicator { position: absolute; top: -12px; right: 10px; width: 11px; height: 11px; background: var(--danger); border-radius: 50%; box-shadow: 0 0 6px #ef444455; border:1.5px solid #fff; display: none; z-index: 2; }
.cart-side .buy-btn:hover{background:#1bb954;}
.cart-side .content{padding:10px;flex:1;overflow:auto;}
.cart-side .item{display:flex;gap:9px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.cart-side .item img{width:48px;height:48px;object-fit:cover;border-radius:6px;}
.cart-side .meta{text-align:right;flex:1;}
.cart-side .meta .name{font-weight:800;font-size:12px;color:var(--text-main);}
.cart-side .meta .sub{color:var(--muted);font-size:10px;margin-top:4px;}
.cart-side .qty{display:flex;gap:6px;align-items:center;}
.cart-side .qty button{background:#eee;border:none;padding:4px 6px;border-radius:6px;cursor:pointer;color:var(--primary-dark);}
.cart-side .qty button:hover{background:var(--primary);color:#fff;}
.cart-side .remove-btn{background:var(--danger);color:#fff;border:none;padding:4px 6px;border-radius:6px;cursor:pointer;font-size:11px;}
.cart-side .footer{padding:15px 10px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px;align-items:stretch;}
.admin-list{margin-top:9px;max-height:192px;overflow:auto;border-top:1px solid var(--border);padding-top:6px;color:var(--text-main);}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;padding:14px;}
.panel{ width:496px;max-width:100%; background:var(--card); padding:12px; border-radius:10px; border:2.7px solid var(--control-border); }
.form-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:7px;}
input[type="text"], input[type="number"], textarea, select{padding:7px;border-radius:7px;border:1px solid var(--border);flex:1;font-size:13px;color:var(--text-main);}
.small-btn{background:var(--primary);color:#fff;padding:6px 9px;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:12px;}
.small-btn:hover{background:var(--danger);}
.img-viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;}
.img-viewer .box{ max-width:72%; max-height:72%; display:flex; align-items:center; justify-content:center; position:relative; }
.img-viewer img{ max-width:100%; max-height:70vh; border-radius:6px; background:#fff; transition: opacity 0.35s, transform 0.33s; opacity: 1; transform: scale(1); }
.img-viewer img.fade { opacity: 0.15; transform: scale(0.96); }
.img-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: var(--primary); color: #fff; border: none; border-radius: 999px; width: 38px; height: 38px; font-size: 22px; cursor: pointer; opacity: 0.93; z-index: 10; transition: background 0.18s, opacity 0.18s; }
.img-arrow:hover { background: var(--primary-dark); opacity: 1; }
.img-arrow.left { left: -24px; }
.img-arrow.right { right: -24px; }
.center{display:flex;align-items:center;justify-content:center;}
.thumbs{display:flex;gap:6px;justify-content:center;margin-top:8px;}
.thumb{width:42px;height:34px;object-fit:cover;border-radius:6px;border:1px solid var(--border);cursor:pointer;opacity:0.95;}
.thumb.active{border:2px solid var(--primary);opacity:1;}
@media (max-width:860px){ .grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));} .cart-side.open{width:78%;} .panel{width:90%;} .img-arrow.left { left: -8px;} .img-arrow.right { right: -8px;} }
@media (max-width:420px){ .card .main-img{height:110px;} .thumb{width:28px;height:20px;} .img-arrow.left { left: 0;} .img-arrow.right { right: 0;} }
</style>
</head>
<body>

<header>
  <div style="display:flex;gap:8px;align-items:center;">
    <div class="logo" title="Ø§Ù„Ù…ØªØ¬Ø±">
      <div class="title">Ù…ØªØ¬Ø±<br>Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</div>
    </div>
  </div>
  <nav>
    <a id="nav-home" href="#home" class="active">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <a id="nav-offers" href="#offers">Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
    <a id="nav-admin" href="#control">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
  </nav>
</header>

<main>
  <section id="home" style="display:block">
    <h2 class="section-title">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
    <div id="productsGrid" class="grid"></div>
  </section>
  <section id="offers" style="display:none">
    <h2 class="section-title">Ø§Ù„Ø¹Ø±ÙˆØ¶</h2>
    <div id="offersGrid" class="grid"></div>
  </section>
</main>

<div class="order-sticker" id="orderSticker" title="Ø¹Ø±Ø¶ Ø§Ù„Ø³Ù„Ø©">
  <div class="sticker-count" id="stickerCount">0</div>
  <div class="icon">ğŸ›’</div>
  <div class="label">Ø§Ù„Ø³Ù„Ø©</div>
</div>

<div class="cart-side" id="cartSide" aria-hidden="true">
  <div class="head">
    <div class="head-controls">
      <div class="title">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</div>
      <div class="total-row">
        <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
        <span id="sideTotalHead">0.00 Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ</span>
      </div>
      <button class="buy-btn" id="buyBtn">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù† Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
        <span class="buy-btn-indicator" id="buyBtnIndicator"></span>
      </button>
    </div>
    <div><button class="close-btn" id="closeCartBtn" aria-label="Ø¥ØºÙ„Ø§Ù‚">âœ–</button></div>
  </div>
  <div class="content" id="sideContent">
    <div id="sideItems"></div>
  </div>
  <div class="footer"></div>
</div>

<div class="img-viewer" id="imgViewer" role="dialog" aria-hidden="true">
  <div class="box center" style="position:relative;">
    <button id="viewerPrev" class="img-arrow left" aria-label="Ø§Ù„Ø³Ø§Ø¨Ù‚">&#8592;</button>
    <img id="viewerImg" src="" alt="ØµÙˆØ±Ø© Ø£ÙƒØ¨Ø±">
    <button id="viewerNext" class="img-arrow right" aria-label="Ø§Ù„ØªØ§Ù„ÙŠ">&#8594;</button>
    <button id="viewerClose" style="position:absolute; top:14px; left:14px; background:#fff;border-radius:6px;padding:4px 6px; cursor:pointer; font-size:18px;">âœ–</button>
  </div>
</div>

<div class="modal" id="adminModal" style="display:none;">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900;font-size:15px;color:var(--text-main);">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
      <div><button class="small-btn" onclick="closeAdmin()">âœ–</button></div>
    </div>
    <div id="loginPanel" class="form-row" style="margin-top:14px;">
      <input id="adminPass" type="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      <button class="small-btn" onclick="adminLogin()">Ø¯Ø®ÙˆÙ„</button>
    </div>
    <div id="controlPanel" style="display:none; margin-top:9px;">
      <div class="form-row">
        <input id="prodName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
        <input id="prodPrice" type="number" placeholder="Ø§Ù„Ø³Ø¹Ø±">
      </div>
      <div class="form-row">
        <input id="prodImages" placeholder="Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØ± Ù…ÙØµÙˆÙ„Ø© Ø¨ÙØ§ØµÙ„Ø© (Ø­ØªÙ‰ 10 Ø±ÙˆØ§Ø¨Ø·)">
      </div>
      <div class="form-row">
        <textarea id="prodDesc" placeholder="Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea>
      </div>
      <div class="form-row">
        <select id="prodType">
          <option value="normal">Ø±Ø¦ÙŠØ³ÙŠØ©</option>
          <option value="offer">Ø¹Ø±Ø¶</option>
        </select>
        <button class="small-btn" id="addUpdateBtn" onclick="addOrUpdateProduct()">Ø¥Ø¶Ø§ÙØ©</button>
      </div>
      <div style="margin-top:9px;color:var(--text-main);"><strong>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</strong></div>
      <div class="admin-list" id="adminList"></div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
/* ------------------- Ø¥Ø¹Ø¯Ø§Ø¯ Supabase ------------------- */
const SUPABASE_URL = 'https://rqiognpfzyyfyferyjah.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxaW9nbnBmenl5ZnlmZXJ5amFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzI2ODcsImV4cCI6MjA3MDMwODY4N30.srA9q_fRyWo0d4htuiC4lyrBg2j5QSABfA1yi_8MSIc';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ------------------- Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø¯ÙŠØªØ§Ø¨ÙŠØ² ------------------- */
let USER_ID = localStorage.getItem('user_id');
if (!USER_ID) {
  USER_ID = (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'u_' + Date.now() + '_' + Math.floor(Math.random()*10000);
  localStorage.setItem('user_id', USER_ID);
}

const ADMIN_PASS = '7732';
let products = [];
let cartItems = [];
let editingProductId = null;

/* ------------------- Ø¹Ù†Ø§ØµØ± DOM ------------------- */
const productsGrid = document.getElementById('productsGrid');
const offersGrid = document.getElementById('offersGrid');
const cartSide = document.getElementById('cartSide');
const sideItems = document.getElementById('sideItems');
const adminModal = document.getElementById('adminModal');
const loginPanel = document.getElementById('loginPanel');
const controlPanel = document.getElementById('controlPanel');
const adminListDiv = document.getElementById('adminList');
const imgViewer = document.getElementById('imgViewer');
const viewerImg = document.getElementById('viewerImg');
const viewerPrev = document.getElementById('viewerPrev');
const viewerNext = document.getElementById('viewerNext');
const viewerClose = document.getElementById('viewerClose');
const orderSticker = document.getElementById('orderSticker');
const stickerCountEl = document.getElementById('stickerCount');
const buyBtn = document.getElementById('buyBtn');
const buyBtnIndicator = document.getElementById('buyBtnIndicator');
const addUpdateBtn = document.getElementById('addUpdateBtn');

/* ------------------- Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ------------------- */
function formatCurrency(v){ return Number(v).toFixed(2); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function logConsole(...args){ try{ console.log(...args); }catch(e){} }

/* ------------------- Global error capture ------------------- */
window.addEventListener('error', function(e){
  console.error('Global error:', e.message || e);
});
window.addEventListener('unhandledrejection', function(e){
  console.error('Unhandled rejection:', e.reason || e);
});

/* ------------------- Navigation (Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…) ------------------- */
function showSection(sectionId, navEl){
  document.querySelectorAll('main section').forEach(sec=>sec.style.display='none');
  const target = document.getElementById(sectionId);
  if (target) target.style.display='block';
  document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
  if (navEl && navEl.classList) navEl.classList.add('active');
  try { history.replaceState(null, '', '#' + sectionId); } catch(e) {}
}
document.getElementById('nav-home').addEventListener('click', function(e){ e.preventDefault(); showSection('home', this); });
document.getElementById('nav-offers').addEventListener('click', function(e){ e.preventDefault(); showSection('offers', this); });
document.getElementById('nav-admin').addEventListener('click', function(e){
  e.preventDefault();
  adminModal.style.display = 'flex';
  loginPanel.style.display = sessionStorage.getItem('adminAuth') === 'true' ? 'none' : 'flex';
  controlPanel.style.display = sessionStorage.getItem('adminAuth') === 'true' ? 'block' : 'none';
});

/* ------------------- Products: fetch ------------------- */
async function fetchProducts(){
  try {
    logConsole('fetchProducts: requesting products from supabase...');
    const { data, error } = await supabase
      .from('products')
      .select('*')
      .order('date_added', { ascending: false });
    if (error) throw error;
    products = data.map(p => {
      if (!p.images) p.images = [];
      return p;
    });
    renderProducts();
    renderOffers();
    attachGalleryHandlers();
    logConsole('fetchProducts: done, count=', products.length);
  } catch (err) {
    console.error('fetchProducts error', err);
    alert('Ø®Ø·Ø£ Ø¨Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯.');
  }
}

/* ------------------- Admin: add/update/delete ------------------- */
async function addOrUpdateProduct(){
  const name = document.getElementById('prodName').value.trim();
  const price = parseFloat(document.getElementById('prodPrice').value);
  const imagesRaw = document.getElementById('prodImages').value.trim();
  const desc = document.getElementById('prodDesc').value.trim();
  const type = document.getElementById('prodType').value;
  if (!name || !imagesRaw || isNaN(price)) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØµÙˆØ± (Ø±ÙˆØ§Ø¨Ø·) ÙˆØ§Ù„Ø³Ø¹Ø± Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­'); return; }
  const images = imagesRaw.split(',').map(s=>s.trim()).filter(s=>s).slice(0,10);
  try {
    if (editingProductId) {
      const { data, error } = await supabase.from('products').update({
        name, price, images, description: desc, type, date_added: new Date().toISOString()
      }).eq('id', editingProductId);
      if (error) throw error;
      editingProductId = null;
      addUpdateBtn.textContent = 'Ø¥Ø¶Ø§ÙØ©';
      logConsole('Product updated', data);
    } else {
      const { data, error } = await supabase.from('products').insert([{
        name, price, images, description: desc, type, date_added: new Date().toISOString()
      }]);
      if (error) throw error;
      logConsole('Product inserted', data);
    }
    document.getElementById('prodName').value='';
    document.getElementById('prodPrice').value='';
    document.getElementById('prodImages').value='';
    document.getElementById('prodDesc').value='';
    document.getElementById('prodType').value='normal';
    await fetchProducts();
    await loadAdminList();
  } catch (err) {
    console.error('addOrUpdateProduct error', err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬. ØªØ­Ù‚Ù‚ Ù…Ù† Console.');
  }
}

function editProduct(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  editingProductId = id;
  document.getElementById('prodName').value = p.name || '';
  document.getElementById('prodPrice').value = p.price || '';
  document.getElementById('prodImages').value = Array.isArray(p.images) ? p.images.join(', ') : '';
  document.getElementById('prodDesc').value = p.description || '';
  document.getElementById('prodType').value = p.type || 'normal';
  addUpdateBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„';
  sessionStorage.setItem('adminAuth','true');
  loginPanel.style.display='none'; controlPanel.style.display='block';
}

async function deleteProduct(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ØŸ')) return;
  try {
    await supabase.from('orders').delete().eq('product_id', id);
    const { data, error } = await supabase.from('products').delete().eq('id', id);
    if (error) throw error;
    await fetchProducts();
    await fetchCart();
    await loadAdminList();
    logConsole('Product deleted', id);
  } catch (err) {
    console.error('deleteProduct error', err);
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬');
  }
}

/* ------------------- Admin list UI ------------------- */
async function loadAdminList(){
  try {
    const { data, error } = await supabase.from('products').select('*').order('date_added', { ascending: false });
    if (error) throw error;
    adminListDiv.innerHTML = '';
    data.forEach(p=>{
      const row = document.createElement('div');
      row.style.display='flex';
      row.style.justifyContent='space-between';
      row.style.alignItems='center';
      row.style.padding='6px 0';
      row.innerHTML = `
        <div style="max-width:70%"><strong>${escapeHtml(p.name)}</strong><br><small style="color:#333">${escapeHtml(p.description||'')}</small></div>
        <div style="display:flex;gap:6px">
          <button class="small-btn" onclick="editProduct(${p.id})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button style="background:var(--danger);color:#fff;padding:6px 7px;border-radius:8px;border:0;cursor:pointer;font-size:11px;" onclick="deleteProduct(${p.id})">Ø­Ø°Ù</button>
        </div>
      `;
      adminListDiv.appendChild(row);
    });
  } catch (err) {
    console.error('loadAdminList error', err);
  }
}

/* ------------------- Gallery handlers ------------------- */
function attachGalleryHandlers(){
  document.querySelectorAll('.thumb').forEach(t=>{
    // remove previous listeners by cloning (robust)
    const newT = t.cloneNode(true);
    t.parentNode.replaceChild(newT, t);
    newT.addEventListener('click', function(){
      const card = this.closest('.card');
      const main = card.querySelector('.main-img');
      card.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
      this.classList.add('active');
      main.classList.add('fade');
      setTimeout(()=>{ main.src = this.src; main.classList.remove('fade'); }, 180);
      main.dataset.index = this.dataset.index;
    });
  });
  document.querySelectorAll('.main-img').forEach(m=>{
    const newM = m.cloneNode(true);
    m.parentNode.replaceChild(newM, m);
    newM.addEventListener('click', function(){
      const id = Number(this.dataset.id);
      const prod = products.find(p=>p.id===id);
      if(!prod) return;
      const imgs = Array.isArray(prod.images) && prod.images.length ? prod.images : [''];
      let start = Number(this.dataset.index || 0);
      openViewer(imgs, start);
    });
  });
}

/* ------------------- Image viewer ------------------- */
let viewerImgs = [], viewerIndex = 0;
function openViewer(imgs, startIndex = 0){
  viewerImgs = imgs;
  viewerIndex = startIndex || 0;
  changeViewerImg(viewerImgs[viewerIndex] || '');
  imgViewer.style.display='flex';
  imgViewer.setAttribute('aria-hidden','false');
}
function changeViewerImg(newSrc){
  viewerImg.classList.add('fade');
  setTimeout(()=>{
    viewerImg.src = newSrc;
    viewerImg.onload = ()=> viewerImg.classList.remove('fade');
  }, 180);
}
function closeViewer(){ imgViewer.style.display='none'; imgViewer.setAttribute('aria-hidden','true'); }
viewerPrev.addEventListener('click', ()=>{ if(!viewerImgs.length) return; viewerIndex = (viewerIndex-1+viewerImgs.length)%viewerImgs.length; changeViewerImg(viewerImgs[viewerIndex]); });
viewerNext.addEventListener('click', ()=>{ if(!viewerImgs.length) return; viewerIndex = (viewerIndex+1)%viewerImgs.length; changeViewerImg(viewerImgs[viewerIndex]); });
viewerClose.addEventListener('click', closeViewer);
imgViewer.addEventListener('click', e => { if (e.target === imgViewer) closeViewer(); });

/* ------------------- Render Products & Offers ------------------- */
function renderProducts(){
  productsGrid.innerHTML = '';
  const now = Date.now();
  products.filter(p => p.type === 'normal').forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    const imgs = Array.isArray(p.images) ? p.images.slice(0,10) : [];
    const main = imgs[0] || '';
    const dateAdded = p.date_added ? new Date(p.date_added).getTime() : 0;
    card.innerHTML = `
      <div class="gallery">
        ${(now - dateAdded < 24*60*60*1000) ? '<div class="badge-new">NEW</div>' : ''}
        <img src="${escapeHtml(main)}" class="main-img" alt="${escapeHtml(p.name)}" data-id="${p.id}" data-index="0">
        <div class="thumbs">
          ${imgs.map((u,i)=>`<img src="${escapeHtml(u)}" class="thumb ${i===0?'active':''}" data-id="${p.id}" data-index="${i}" alt="thumb">`).join('')}
        </div>
      </div>
      <h4>${escapeHtml(p.name)}</h4>
      <p class="desc">${escapeHtml(p.description||'')}</p>
      <p class="price">${formatCurrency(p.price)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ</p>
      <button class="add-btn" onclick="addToCartById(${p.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
    `;
    productsGrid.appendChild(card);
  });
  attachGalleryHandlers();
}

function renderOffers(){
  offersGrid.innerHTML = '';
  const now = Date.now();
  products.filter(p => p.type === 'offer').forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    const imgs = Array.isArray(p.images) ? p.images.slice(0,10) : [];
    const main = imgs[0] || '';
    const dateAdded = p.date_added ? new Date(p.date_added).getTime() : 0;
    card.innerHTML = `
      <div class="gallery">
        ${(now - dateAdded < 24*60*60*1000) ? '<div class="badge-new">NEW</div>' : ''}
        <img src="${escapeHtml(main)}" class="main-img" alt="${escapeHtml(p.name)}" data-id="${p.id}" data-index="0">
        <div class="thumbs">
          ${imgs.map((u,i)=>`<img src="${escapeHtml(u)}" class="thumb ${i===0?'active':''}" data-id="${p.id}" data-index="${i}" alt="thumb">`).join('')}
        </div>
      </div>
      <h4>${escapeHtml(p.name)}</h4>
      <p class="desc">${escapeHtml(p.description||'')}</p>
      <p class="price">${formatCurrency(p.price)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ</p>
      <button class="add-btn" onclick="addToCartById(${p.id})">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
    `;
    offersGrid.appendChild(card);
  });
  attachGalleryHandlers();
}

/* ------------------- Cart (orders table CRUD) ------------------- */
async function fetchCart(){
  try {
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .eq('user_id', USER_ID)
      .order('created_at', { ascending: true });
    if (error) throw error;
    cartItems = data || [];
    renderCartViews();
    updateSticker(false);
    logConsole('fetchCart: items=', cartItems.length);
  } catch (err) {
    console.error('fetchCart error', err);
    // Ù„Ø§ ØªÙˆÙ‚Ù Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  }
}

async function addToCartById(productId){
  try {
    const { data: existing, error: selErr } = await supabase
      .from('orders')
      .select('*')
      .eq('user_id', USER_ID)
      .eq('product_id', productId)
      .single();
    if (selErr && selErr.code && selErr.code !== 'PGRST116') { console.warn('select single err', selErr); }
    if (existing && existing.id) {
      await supabase.from('orders').update({ quantity: existing.quantity + 1 }).eq('id', existing.id);
    } else {
      await supabase.from('orders').insert([{ user_id: USER_ID, product_id: productId, quantity: 1, created_at: new Date().toISOString() }]);
    }
    await fetchCart();
    buyBtn.classList.add('blink');
    buyBtnIndicator.style.display = "none";
    setTimeout(()=>{ buyBtn.classList.remove('blink'); buyBtnIndicator.style.display = "block"; }, 1500);
  } catch (err) {
    console.error('addToCartById error', err);
    alert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©. Ø§ÙØªØ­ Console Ù„Ù„Ù…Ø²ÙŠØ¯.');
  }
}

async function updateQty(productId, delta){
  try {
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .eq('user_id', USER_ID)
      .eq('product_id', productId)
      .single();
    if (error && error.code !== 'PGRST116') throw error;
    if (!data) return;
    const newQty = data.quantity + delta;
    if (newQty <= 0) {
      await supabase.from('orders').delete().eq('id', data.id);
    } else {
      await supabase.from('orders').update({ quantity: newQty }).eq('id', data.id);
    }
    await fetchCart();
  } catch (err) {
    console.error('updateQty error', err);
  }
}

async function removeFromCart(productId){
  try {
    const { data, error } = await supabase
      .from('orders')
      .select('*')
      .eq('user_id', USER_ID)
      .eq('product_id', productId)
      .single();
    if (data && data.id) {
      await supabase.from('orders').delete().eq('id', data.id);
      await fetchCart();
    }
  } catch (err) {
    console.error('removeFromCart error', err);
  }
}

function renderCartViews(){
  sideItems.innerHTML = '';
  let total = 0;
  cartItems.forEach(ci=>{
    const p = products.find(x=>x.id === ci.product_id);
    if(!p) return;
    total += p.price * ci.quantity;
    const item = document.createElement('div'); item.className='item';
    const imgSrc = (Array.isArray(p.images) && p.images.length) ? p.images[0] : '';
    item.innerHTML = `
      <img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(p.name)}">
      <div class="meta">
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="sub">${formatCurrency(p.price)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ Ã— ${ci.quantity}</div>
      </div>
      <div class="qty">
        <button onclick="updateQty(${p.id},-1)">-</button>
        <span style="min-width:18px;text-align:center">${ci.quantity}</span>
        <button onclick="updateQty(${p.id},+1)">+</button>
      </div>
      <div style="margin-left:6px"><button class="remove-btn" onclick="removeFromCart(${p.id})">Ø­Ø°Ù</button></div>
    `;
    sideItems.appendChild(item);
  });
  document.getElementById('sideTotalHead').textContent = formatCurrency(total) + ' Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ';
  const count = cartItems.reduce((s,i)=>s+i.quantity,0);
  stickerCountEl.textContent = count;
  stickerCountEl.style.display = count ? 'block' : 'none';
}

/* ------------------- Cart UI open/close ------------------- */
function openSideCart(){
  fetchCart();
  cartSide.classList.add('open');
  cartSide.setAttribute('aria-hidden','false');
  updateSticker(false);
  buyBtn.classList.add('blink');
  buyBtnIndicator.style.display = "none";
  setTimeout(()=>{ buyBtn.classList.remove('blink'); buyBtnIndicator.style.display = "block"; }, 5000);
}
function closeSideCart(){
  cartSide.classList.remove('open');
  cartSide.setAttribute('aria-hidden','true');
  buyBtnIndicator.style.display = "none";
  buyBtn.classList.remove('blink');
}
document.getElementById('closeCartBtn').addEventListener('click', ()=> closeSideCart());
orderSticker.addEventListener('click', ()=> openSideCart());

function updateSticker(on){
  const c = cartItems.reduce((s,i)=>s+i.quantity,0);
  stickerCountEl.textContent = c;
  stickerCountEl.style.display = c ? 'block' : 'none';
}

/* ------------------- Admin modal and login ------------------- */
function closeAdmin(){ adminModal.style.display='none'; }

function adminLogin(){
  const pass = document.getElementById('adminPass').value;
  if (pass === ADMIN_PASS) {
    sessionStorage.setItem('adminAuth','true');
    loginPanel.style.display='none';
    controlPanel.style.display='block';
    loadAdminList();
  } else {
    alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©');
  }
}

/* ------------------- Buy via WhatsApp ------------------- */
buyBtn.addEventListener('click', async function(){
  await fetchCart();
  if (cartItems.length === 0){ alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); return; }
  let text = "Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£ÙˆØ¯ ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø´Ø±Ø§Ø¡:\n";
  text += "---------------------\n";
  text += "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:\n";
  let total = 0;
  cartItems.forEach((ci, idx) => {
    const p = products.find(x => x.id === ci.product_id);
    if(!p) return;
    text += `${idx + 1}. ${p.name} Ã— ${ci.quantity} = ${formatCurrency(p.price * ci.quantity)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ\n`;
    total += p.price * ci.quantity;
  });
  text += "---------------------\n";
  text += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${formatCurrency(total)} Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ\n\n`;
  text += "ÙŠØ±Ø¬Ù‰ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ Ø£Ùˆ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø±. Ø´ÙƒØ±Ù‹Ø§ Ù„ÙƒÙ…!";
  window.open(`https://wa.me/77324648?text=${encodeURIComponent(text)}`, '_blank');
});

/* ------------------- misc handlers ------------------- */
document.addEventListener('keydown', function(e){
  if (e.key === 'Escape') {
    if (imgViewer.style.display === 'flex') closeViewer();
    if (adminModal.style.display === 'flex') closeAdmin();
  }
});

/* ------------------- Init ------------------- */
(async function init(){
  await fetchProducts();
  await fetchCart();
  await loadAdminList();
  // Ø§ÙØªØ­ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù…Ù† Ø§Ù„Ù‡Ø§Ø´
  const h = (window.location.hash || '#home').replace('#','');
  if (h === 'offers') showSection('offers', document.getElementById('nav-offers'));
  else showSection('home', document.getElementById('nav-home'));
})();
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>متجر إلكتروني هادئ وأنيق</title>
<style>
:root{
  --primary: #3b82f6;
  --primary-dark: #2563eb;
  --secondary: #fff;
  --background: #fff;
  --text-main: #000;
  --muted: #888;
  --danger: #ef4444;
  --success: #25D366;
  --card: #fff;
  --border: #e5e7eb;
  --active-bg: #f6f6f6;
  --control-border: #111;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:Tahoma,Arial,Helvetica,sans-serif;
  background:var(--background);
  color:var(--text-main);
}
header{
  position:sticky; top:0; z-index:120;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 16px;
  background: var(--secondary);
}
.logo .title{ color:var(--text-main); font-weight:900; }
nav{
  display:flex; gap:12px; align-items:center; position:relative;
  min-height:50px;
  background: var(--secondary);
  border-bottom: 2.5px solid var(--border);
}
nav a{
  text-decoration:none;
  color:var(--text-main);
  padding:7px 16px;
  border-radius:11px;
  font-weight:700;
  cursor:pointer;
  background:none;
  position:relative;
  transition:background 0.19s, color 0.18s, border 0.19s;
  border:2.7px solid transparent;
}
nav a.active{
  background:var(--active-bg);
  color:var(--text-main);
  border:2.7px solid var(--danger);
}
nav a:not(.active):hover{background:var(--active-bg);}
nav a:not(.active){color:var(--text-main);}
main{ padding:14px; max-width:960px; margin:0 auto 100px auto; color:var(--text-main);}
.section-title{ margin:6px 0 12px; font-size:16px; font-weight:700; color:var(--text-main);}
.grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(152px,1fr)); gap:14px;}
.card{
  background:var(--card);
  border-radius:12px;
  padding:12px;
  border:1.5px solid var(--border);
  position:relative; overflow:visible; text-align:center;
  color:var(--text-main);
}
.card h4{margin:7px 0 4px;font-size:13px;color:var(--text-main);}
.card p.desc{font-size:10px;color:var(--muted);min-height:32px;}
.card p.price{color:var(--danger);font-weight:800;margin:6px 0;}
.card .add-btn{
  background:var(--primary);
  color:#fff;
  border:0;padding:6px 10px;border-radius:8px;cursor:pointer;
  font-weight:800;font-size:12px;
  transition:background 0.18s;
}
.card .add-btn:hover{background:var(--primary-dark);}
.badge-new{
  position:absolute;top:7px;left:7px;
  background:transparent;
  color:var(--danger);
  padding:4px 6px;
  border-radius:6px;
  font-weight:800;font-size:10px;
  border:1px solid var(--danger);
}
.gallery img.main-img{
  width:100%;
  height:140px;
  object-fit:cover;
  border-radius:8px;
  display:block;
  margin-bottom:8px;
  transition: opacity 0.25s, transform 0.2s;
}
.thumb{width:28px;height:24px;object-fit:cover;border-radius:6px;border:1px solid var(--border);margin:2px;cursor:pointer;opacity:0.9;}
.thumb.active{outline:2px solid var(--primary);opacity:1;}
.thumbs{display:flex;justify-content:center;gap:6px;margin-top:6px;}
.order-sticker{
  position:fixed;
  left:18px;
  bottom:22px;
  width:65px;height:65px;
  background:var(--secondary);
  border-radius:15px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  border:2px solid var(--border);
  cursor:pointer;
  color:var(--text-main);
  box-shadow:0 2px 12px rgba(0,0,0,0.07);
}
.order-sticker .icon{font-size:22px; color:var(--text-main);}
.order-sticker .label{font-size:12px;color:var(--text-main);font-weight:900;margin-top:4px;}
.sticker-count{
  position:absolute;
  top:8px;right:8px;
  background:var(--danger);
  color:#fff;
  font-size:10px;
  padding:4px 6px;
  border-radius:999px;
  display:none;
  font-weight:900;
}
.cart-side{
  position:fixed;left:0;top:0;height:100vh;width:0;overflow:hidden;z-index:600;
  background:var(--secondary);
  border-top-right-radius:14px;border-bottom-right-radius:14px;transition:width 0.28s;display:flex;flex-direction:column;
  border-right:2px solid var(--primary);
  color:var(--text-main);
}
.cart-side.open{width:304px;}
.cart-side .head{padding:12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);}
.cart-side .title{font-weight:900;font-size:15px;color:var(--text-main);}
.cart-side .close-btn{background:transparent;border:none;font-size:18px;cursor:pointer;color:var(--danger);}
.cart-side .head-controls{display:flex;align-items:center;gap:10px;}
.cart-side .total-row{font-size:13px;color:var(--text-main);}
.cart-side .buy-btn{
  background:var(--success);
  color:#fff;border:none;padding:7px 10px;border-radius:8px;font-weight:900;cursor:pointer;
  font-size:12px;
  transition:background 0.18s;
  position:relative;
  box-shadow: 0 3px 8px #25d3662b;
}
.cart-side .buy-btn.blink{
  animation: blinkBtn 0.7s alternate infinite;
}
@keyframes blinkBtn {
  0% {box-shadow:0 0 0 0px var(--danger);}
  60% {box-shadow:0 0 0 14px var(--danger);}
  100% {box-shadow:0 0 0 0px var(--danger);}
}
.buy-btn-indicator {
  position: absolute;
  top: -12px;
  right: 10px;
  width: 11px;
  height: 11px;
  background: var(--danger);
  border-radius: 50%;
  box-shadow: 0 0 6px #ef444455;
  border:1.5px solid #fff;
  display: none;
  z-index: 2;
}
.cart-side .buy-btn:hover{background:#1bb954;}
.cart-side .content{padding:10px;flex:1;overflow:auto;}
.cart-side .item{display:flex;gap:9px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);}
.cart-side .item img{width:48px;height:48px;object-fit:cover;border-radius:6px;}
.cart-side .meta{text-align:right;flex:1;}
.cart-side .meta .name{font-weight:800;font-size:12px;color:var(--text-main);}
.cart-side .meta .sub{color:var(--muted);font-size:10px;margin-top:4px;}
.cart-side .qty{display:flex;gap:6px;align-items:center;}
.cart-side .qty button{background:#eee;border:none;padding:4px 6px;border-radius:6px;cursor:pointer;color:var(--primary-dark);}
.cart-side .qty button:hover{background:var(--primary);color:#fff;}
.cart-side .remove-btn{background:var(--danger);color:#fff;border:none;padding:4px 6px;border-radius:6px;cursor:pointer;font-size:11px;}
.cart-side .footer{padding:15px 10px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:8px;align-items:stretch;}
.admin-list{margin-top:9px;max-height:192px;overflow:auto;border-top:1px solid var(--border);padding-top:6px;color:var(--text-main);}
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:900;padding:14px;}
.panel{
  width:496px;max-width:100%;
  background:var(--card);
  padding:12px;
  border-radius:10px;
  border:2.7px solid var(--control-border);
}
.form-row{display:flex;gap:7px;flex-wrap:wrap;margin-top:7px;}
input[type="text"], input[type="number"], textarea, select{padding:7px;border-radius:7px;border:1px solid var(--border);flex:1;font-size:13px;color:var(--text-main);}
.small-btn{background:var(--primary);color:#fff;padding:6px 9px;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:12px;}
.small-btn:hover{background:var(--danger);}
.img-viewer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1200;}
.img-viewer .box{
  max-width:72%;
  max-height:72%;
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
}
.img-viewer img{
  max-width:100%;
  max-height:70vh;
  border-radius:6px;
  background:#fff;
  transition: opacity 0.35s, transform 0.33s;
  opacity: 1;
  transform: scale(1);
}
.img-viewer img.fade {
  opacity: 0.15;
  transform: scale(0.96);
}
.img-arrow {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: var(--primary);
  color: #fff;
  border: none;
  border-radius: 999px;
  width: 38px;
  height: 38px;
  font-size: 22px;
  cursor: pointer;
  opacity: 0.93;
  z-index: 10;
  transition: background 0.18s, opacity 0.18s;
}
.img-arrow:hover {
  background: var(--primary-dark);
  opacity: 1;
}
.img-arrow.left { left: -24px; }
.img-arrow.right { right: -24px; }
.center{display:flex;align-items:center;justify-content:center;}
@media (max-width:860px){
  .grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr));}
  .cart-side.open{width:78%;}
  .panel{width:90%;}
  .img-arrow.left { left: -8px;}
  .img-arrow.right { right: -8px;}
}
@media (max-width:420px){
  .card .main-img{height:110px;}
  .thumb{width:28px;height:20px;}
  .img-arrow.left { left: 0;}
  .img-arrow.right { right: 0;}
}
</style>
</head>
<body>

<header>
  <div style="display:flex;gap:8px;align-items:center;">
    <div class="logo" title="المتجر">
      <div class="title">متجر<br>الكتروني</div>
    </div>
  </div>
  <nav>
    <a id="nav-home" href="#home" class="active">الرئيسية</a>
    <a id="nav-offers" href="#offers">العروض</a>
    <a id="nav-admin" href="#control">لوحة التحكم</a>
  </nav>
</header>

<main>
  <section id="home" style="display:block">
    <h2 class="section-title">المنتجات</h2>
    <div id="productsGrid" class="grid"></div>
  </section>
  <section id="offers" style="display:none">
    <h2 class="section-title">العروض</h2>
    <div id="offersGrid" class="grid"></div>
  </section>
</main>

<div class="order-sticker" id="orderSticker" title="عرض السلة">
  <div class="sticker-count" id="stickerCount">0</div>
  <div class="icon">🛒</div>
  <div class="label">السلة</div>
</div>

<div class="cart-side" id="cartSide" aria-hidden="true">
  <div class="head">
    <div class="head-controls" style="gap:12px;">
      <div class="title">سلة المشتريات</div>
      <div class="total-row">
        <span>الإجمالي:</span>
        <span id="sideTotalHead">0.00 ريال عماني</span>
      </div>
      <button class="buy-btn" id="buyBtn">اطلب الآن عبر واتساب
        <span class="buy-btn-indicator" id="buyBtnIndicator"></span>
      </button>
    </div>
    <div><button class="close-btn" id="closeCartBtn" aria-label="إغلاق">✖</button></div>
  </div>
  <div class="content" id="sideContent">
    <div id="sideItems"></div>
  </div>
  <div class="footer">
    <div style="display:flex;gap:8px;">
      <button class="small-btn" id="saveOrderBtn">حفظ الطلب</button>
      <button style="background:#f3f4f6;border:1px solid var(--border);padding:8px;border-radius:8px;cursor:pointer;" id="clearCartBtn">تفريغ السلة</button>
    </div>
  </div>
</div>

<div class="img-viewer" id="imgViewer" role="dialog" aria-hidden="true">
  <div class="box center" style="position:relative;">
    <button id="viewerPrev" class="img-arrow left" aria-label="السابق">&#8592;</button>
    <img id="viewerImg" src="" alt="صورة أكبر">
    <button id="viewerNext" class="img-arrow right" aria-label="التالي">&#8594;</button>
    <button id="viewerClose" style="position:absolute; top:14px; left:14px; background:#fff;border-radius:6px;padding:4px 6px; cursor:pointer; font-size:18px;">✖</button>
  </div>
</div>

<div class="modal" id="adminModal" style="display:none;">
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <div style="font-weight:900;font-size:15px;color:var(--text-main);">لوحة التحكم</div>
      <div><button class="small-btn" onclick="closeAdmin()">✖</button></div>
    </div>
    <div id="loginPanel" class="form-row" style="margin-top:14px;">
      <input id="adminPass" type="password" placeholder="أدخل كلمة المرور">
      <button class="small-btn" id="adminLoginBtn">دخول</button>
    </div>
    <div id="controlPanel" style="display:none; margin-top:9px;">
      <div class="form-row">
        <input id="prodName" placeholder="اسم المنتج">
        <input id="prodPrice" type="number" placeholder="السعر">
      </div>
      <div class="form-row">
        <input id="prodImages" placeholder="روابط الصور مفصولة بفاصلة (حتى 4 روابط)">
      </div>
      <div class="form-row">
        <textarea id="prodDesc" placeholder="الوصف (اختياري)"></textarea>
      </div>
      <div class="form-row">
        <select id="prodType">
          <option value="normal">رئيسية</option>
          <option value="offer">عرض</option>
        </select>
        <button class="small-btn" id="submitProductBtn">حفظ / إضافة</button>
      </div>
      <div style="margin-top:9px;color:var(--text-main);"><strong>المنتجات الحالية</strong></div>
      <div class="admin-list" id="adminList"></div>
    </div>
  </div>
</div>

<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

<script>
/* ============ إعداد Supabase ============ */
const SUPABASE_URL = "https://rqiognpfzyyfyferyjah.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxaW9nbnBmenl5ZnlmZXJ5amFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3MzI2ODcsImV4cCI6MjA3MDMwODY4N30.srA9q_fRyWo0d4htuiC4lyrBg2j5QSABfA1yi_8MSIc";
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ============ ثوابت الحالة ============ */
const PRODUCTS_TABLE = 'products';
const ORDERS_TABLE = 'orders';
const USER_ID_KEY = 'store_user_id_v1';
const CART_KEY = 'my_cart_v3';
const ADMIN_PASS = '7732';

let products = [];
let cart = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
let editingProductId = null;

/* عناصر DOM سيتم الحصول عليها بعد DOMContentLoaded */
let productsGrid, offersGrid, cartSide, sideItems, adminModal, loginPanel, controlPanel, adminListDiv;
let imgViewer, viewerImg, viewerPrev, viewerNext, viewerClose;
let orderSticker, stickerCountEl, buyBtn, buyBtnIndicator, saveOrderBtn, clearCartBtn;
let navHome, navOffers, navAdmin, closeCartBtn, adminLoginBtn, submitProductBtn;

/* ============ مساعدة المستخدم ============ */
function getOrCreateUserId(){
  let uid = localStorage.getItem(USER_ID_KEY);
  if(!uid){
    uid = 'u_' + Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);
    localStorage.setItem(USER_ID_KEY, uid);
  }
  return uid;
}
const USER_ID = getOrCreateUserId();

/* ============ وظائف مساعدة عامة ============ */
function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
function formatCurrency(v){ return Number(v || 0).toFixed(2); }
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ============ دوال متاحة عالمياً (حتى تعمل مع onclick بالـ HTML) ============ */
window.addToCartById = function(id){
  const product = products.find(p=>p.id == id);
  if(!product) return;
  const existing = cart.find(c=>c.id == id);
  if(existing) existing.qty += 1;
  else cart.push({ id: product.id, qty: 1 });
  saveCart();
  renderCartViews();
  updateSticker(true);
};
window.updateQty = function(id, delta){
  const item = cart.find(c=>c.id == id);
  if(!item) return;
  item.qty += delta;
  if(item.qty <= 0) cart = cart.filter(c=>c.id != id);
  saveCart();
  renderCartViews();
};
window.removeFromCart = function(id){
  if(!confirm('هل تريد حذف هذا المنتج من السلة؟')) return;
  cart = cart.filter(c=>c.id != id);
  saveCart();
  renderCartViews();
};

/* ============ جلب المنتجات من Supabase ============ */
async function fetchProductsFromSupabase(){
  try{
    const { data, error } = await supabase.from(PRODUCTS_TABLE).select('*').order('date_added', { ascending: false });
    if(error) throw error;
    products = Array.isArray(data) ? data.map(p=>{
      const imgs = p.images && Array.isArray(p.images) ? p.images
                 : (typeof p.images === 'string' && p.images ? p.images.split(',').map(s=>s.trim()) : []);
      return { ...p, images: imgs };
    }) : [];
    renderProducts();
    renderOffers();
    renderCartViews();
    loadAdminList();
  }catch(err){
    console.error('خطأ في جلب المنتجات:', err);
    alert('حدث خطأ أثناء جلب المنتجات من القاعدة. تحقق من الكونسول.');
  }
}

/* ============ رندر المنتجات والعروض ============ */
function renderProducts(){
  if(!productsGrid) return;
  productsGrid.innerHTML = '';
  const now = Date.now();
  products.filter(p=>p.type==='normal' || !p.type).forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    const imgs = Array.isArray(p.images) ? p.images.slice(0,4) : [];
    const main = imgs[0] || '';
    card.innerHTML = `
      <div class="gallery">
        ${(now - new Date(p.date_added || p.dateAdded || 0)) < 24*60*60*1000 ? '<div class="badge-new">NEW</div>' : ''}
        <img src="${escapeHtml(main)}" class="main-img" alt="${escapeHtml(p.name)}" data-id="${p.id}" data-index="0">
        <div class="thumbs">
          ${imgs.map((u,i)=>`<img src="${escapeHtml(u)}" class="thumb ${i===0?'active':''}" data-id="${p.id}" data-index="${i}" alt="thumb">`).join('')}
        </div>
      </div>
      <h4>${escapeHtml(p.name)}</h4>
      <p class="desc">${escapeHtml(p.description || p.desc || '')}</p>
      <p class="price">${formatCurrency(p.price)} ريال عماني</p>
      <button class="add-btn" onclick="addToCartById(${p.id})">أضف للسلة</button>
    `;
    productsGrid.appendChild(card);
  });
  attachGalleryHandlers();
}
function renderOffers(){
  if(!offersGrid) return;
  offersGrid.innerHTML = '';
  const now = Date.now();
  products.filter(p=>p.type==='offer').forEach(p=>{
    const card = document.createElement('div');
    card.className = 'card';
    const imgs = Array.isArray(p.images) ? p.images.slice(0,4) : [];
    const main = imgs[0] || '';
    card.innerHTML = `
      <div class="gallery">
        ${(now - new Date(p.date_added || p.dateAdded || 0)) < 24*60*60*1000 ? '<div class="badge-new">NEW</div>' : ''}
        <img src="${escapeHtml(main)}" class="main-img" alt="${escapeHtml(p.name)}" data-id="${p.id}" data-index="0">
        <div class="thumbs">
          ${imgs.map((u,i)=>`<img src="${escapeHtml(u)}" class="thumb ${i===0?'active':''}" data-id="${p.id}" data-index="${i}" alt="thumb">`).join('')}
        </div>
      </div>
      <h4>${escapeHtml(p.name)}</h4>
      <p class="desc">${escapeHtml(p.description || p.desc || '')}</p>
      <p class="price">${formatCurrency(p.price)} ريال عماني</p>
      <button class="add-btn" onclick="addToCartById(${p.id})">أضف للسلة</button>
    `;
    offersGrid.appendChild(card);
  });
  attachGalleryHandlers();
}

/* ============ عارضة الصور ============ */
let viewerImgs=[]; let viewerIndex=0;
function changeViewerImg(newSrc){
  viewerImg.classList.add('fade');
  setTimeout(()=>{
    viewerImg.src = newSrc || '';
    viewerImg.onload = ()=> viewerImg.classList.remove('fade');
  },180);
}
function attachGalleryHandlers(){
  document.querySelectorAll('.thumb').forEach(t=>{
    t.removeEventListener('click', thumbClickHandler);
    t.addEventListener('click', thumbClickHandler);
  });
  document.querySelectorAll('.main-img').forEach(m=>{
    m.removeEventListener('click', mainImgClickHandler);
    m.addEventListener('click', mainImgClickHandler);
  });
}
function thumbClickHandler(){
  const t = this;
  const card = t.closest('.card');
  const main = card.querySelector('.main-img');
  card.querySelectorAll('.thumb').forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  main.classList.add('fade');
  setTimeout(()=>{ main.src = t.src; main.classList.remove('fade'); },180);
  main.dataset.index = t.dataset.index;
}
function mainImgClickHandler(){
  const id = this.dataset.id ? Number(this.dataset.id) : this.dataset.id;
  const prod = products.find(p=>p.id == id);
  if(!prod) return;
  const imgs = Array.isArray(prod.images) && prod.images.length ? prod.images : [''];
  const start = Number(this.dataset.index || 0);
  openViewer(imgs, start);
}
function openViewer(imgs, startIndex=0){
  viewerImgs = imgs;
  viewerIndex = startIndex || 0;
  changeViewerImg(viewerImgs[viewerIndex] || '');
  imgViewer.style.display = 'flex';
  imgViewer.setAttribute('aria-hidden','false');
}
function closeViewer(){
  imgViewer.style.display = 'none';
  imgViewer.setAttribute('aria-hidden','true');
}

/* ============ سلوك السلة ============ */
function renderCartViews(){
  if(!sideItems) return;
  sideItems.innerHTML = '';
  let total = 0;
  cart.forEach(ci=>{
    const p = products.find(x=>x.id == ci.id);
    if(!p) return;
    total += (Number(p.price) || 0) * ci.qty;
    const item = document.createElement('div'); item.className = 'item';
    const imgSrc = (Array.isArray(p.images) && p.images.length) ? p.images[0] : '';
    item.innerHTML = `
      <img src="${escapeHtml(imgSrc)}" alt="${escapeHtml(p.name)}">
      <div class="meta">
        <div class="name">${escapeHtml(p.name)}</div>
        <div class="sub">${formatCurrency(p.price)} ريال عماني × ${ci.qty}</div>
      </div>
      <div class="qty">
        <button onclick="updateQty(${p.id},-1)">-</button>
        <span style="min-width:18px;text-align:center">${ci.qty}</span>
        <button onclick="updateQty(${p.id},+1)">+</button>
      </div>
      <div style="margin-left:6px"><button class="remove-btn" onclick="removeFromCart(${p.id})">حذف</button></div>
    `;
    sideItems.appendChild(item);
  });
  document.getElementById('sideTotalHead').textContent = formatCurrency(total) + ' ريال عماني';
  const count = cart.reduce((s,i)=>s+i.qty,0);
  stickerCountEl.textContent = count;
  stickerCountEl.style.display = count ? 'block' : 'none';
}
function updateSticker(on){
  const c = cart.reduce((s,i)=>s+i.qty,0);
  stickerCountEl.textContent = c;
  stickerCountEl.style.display = c ? 'block' : 'none';
}
function openSideCart(){
  cartSide.classList.add('open');
  cartSide.setAttribute('aria-hidden','false');
  updateSticker(false);
  buyBtn.classList.add('blink');
  buyBtnIndicator.style.display = "none";
  setTimeout(()=>{ buyBtn.classList.remove('blink'); buyBtnIndicator.style.display = "block"; },5000);
}
function closeSideCart(){
  cartSide.classList.remove('open');
  cartSide.setAttribute('aria-hidden','true');
  buyBtnIndicator.style.display = "none";
  buyBtn.classList.remove('blink');
}

/* ============ حفظ الطلب في Supabase ============ */
async function saveOrderToSupabase(){
  if(cart.length === 0){ alert('السلة فارغة'); return; }
  if(!confirm('ستتم حفظ طلبك في قاعدة البيانات. متابعة؟')) return;
  try{
    const payload = cart.map(ci=>({
      user_id: USER_ID,
      product_id: ci.id,
      quantity: ci.qty
    }));
    const { data, error } = await supabase.from(ORDERS_TABLE).insert(payload);
    if(error) throw error;
    cart = [];
    saveCart();
    renderCartViews();
    alert('تم حفظ الطلب بنجاح في قاعدة البيانات.');
    closeSideCart();
  }catch(err){
    console.error('خطأ في حفظ الطلبات:', err);
    alert('فشل حفظ الطلب. تحقق من الكونسول.');
  }
}

/* ============ لوحة التحكم CRUD ============ */
async function loadAdminList(){
  try{
    const { data, error } = await supabase.from(PRODUCTS_TABLE).select('*').order('date_added', {ascending:false});
    if(error) throw error;
    adminListDiv.innerHTML = '';
    (data || []).forEach(p=>{
      const row = document.createElement('div');
      row.style.display='flex';
      row.style.justifyContent='space-between';
      row.style.alignItems='center';
      row.style.padding='6px 0';
      row.innerHTML = `<div style="max-width:70%"><strong>${escapeHtml(p.name)}</strong><br><small style="color:#333">${escapeHtml(p.description || p.desc || '')}</small></div>
        <div style="display:flex;gap:6px">
          <button class="small-btn" onclick="startEditProduct('${p.id}')">تعديل</button>
          <button style="background:var(--danger);color:#fff;padding:6px 7px;border-radius:8px;border:0;cursor:pointer;font-size:11px;" onclick="deleteProduct('${p.id}')">حذف</button>
        </div>`;
      adminListDiv.appendChild(row);
    });
  }catch(err){
    console.error('خطأ في جلب منتجات الادمن:', err);
    alert('فشل جلب قائمة المنتجات للوحة التحكم.');
  }
}
function startEditProduct(id){
  const p = products.find(x=>x.id == id);
  if(!p) return;
  editingProductId = id;
  sessionStorage.setItem('adminAuth','true');
  loginPanel.style.display = 'none';
  controlPanel.style.display = 'block';
  document.getElementById('prodName').value = p.name;
  document.getElementById('prodPrice').value = p.price;
  document.getElementById('prodImages').value = Array.isArray(p.images) ? p.images.join(', ') : (p.images || '');
  document.getElementById('prodDesc').value = p.description || p.desc || '';
  document.getElementById('prodType').value = p.type || 'normal';
}
async function deleteProduct(id){
  if(!confirm('هل تريد حذف المنتج نهائيًا؟')) return;
  try{
    const { error } = await supabase.from(PRODUCTS_TABLE).delete().eq('id', id);
    if(error) throw error;
    await fetchProductsFromSupabase();
    alert('تم الحذف.');
  }catch(err){
    console.error('خطأ في حذف المنتج:', err);
    alert('فشل الحذف. تحقق من الكونسول.');
  }
}
async function submitProduct(){
  const name = document.getElementById('prodName').value.trim();
  const price = parseFloat(document.getElementById('prodPrice').value);
  const imagesRaw = document.getElementById('prodImages').value.trim();
  const desc = document.getElementById('prodDesc').value.trim();
  const type = document.getElementById('prodType').value;
  if(!name || !imagesRaw || isNaN(price)){ alert('الرجاء تعبئة الاسم، الصور (روابط) والسعر بشكل صحيح'); return; }
  const imgs = imagesRaw.split(',').map(s=>s.trim()).filter(s=>s).slice(0,4);
  try{
    if(editingProductId){
      const { error } = await supabase.from(PRODUCTS_TABLE).update({
        name, price, images: imgs, description: desc, type, date_added: new Date().toISOString()
      }).eq('id', editingProductId);
      if(error) throw error;
      editingProductId = null;
    }else{
      const { error } = await supabase.from(PRODUCTS_TABLE).insert([{
        name, price, images: imgs, description: desc, type, date_added: new Date().toISOString()
      }]);
      if(error) throw error;
    }
    document.getElementById('prodName').value = '';
    document.getElementById('prodPrice').value = '';
    document.getElementById('prodImages').value = '';
    document.getElementById('prodDesc').value = '';
    document.getElementById('prodType').value = 'normal';
    await fetchProductsFromSupabase();
    loadAdminList();
    alert('تم الحفظ بنجاح.');
  }catch(err){
    console.error('خطأ في حفظ المنتج:', err);
    alert('فشل حفظ المنتج. تحقق من الكونسول.');
  }
}

/* ============ تنقّل الواجهة والأحداث ============ */
function showSection(sec){
  document.getElementById('home').style.display='none';
  document.getElementById('offers').style.display='none';
  document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
  if(sec==='home'){
    document.getElementById('home').style.display='block';
    document.getElementById('nav-home').classList.add('active');
    window.location.hash='#home';
  }else if(sec==='offers'){
    document.getElementById('offers').style.display='block';
    document.getElementById('nav-offers').classList.add('active');
    window.location.hash='#offers';
  }
}
function openAdminModal(){
  adminModal.style.display = 'flex';
  const auth = sessionStorage.getItem('adminAuth') === 'true';
  loginPanel.style.display = auth ? 'none' : 'flex';
  controlPanel.style.display = auth ? 'block' : 'none';
  document.getElementById('adminPass').value = '';
}
function closeAdmin(){ adminModal.style.display = 'none'; }

/* ============ تهيئة بعد تحميل DOM ============ */
document.addEventListener('DOMContentLoaded', ()=> {
  // عناصر DOM
  productsGrid = document.getElementById('productsGrid');
  offersGrid = document.getElementById('offersGrid');
  cartSide = document.getElementById('cartSide');
  sideItems = document.getElementById('sideItems');
  adminModal = document.getElementById('adminModal');
  loginPanel = document.getElementById('loginPanel');
  controlPanel = document.getElementById('controlPanel');
  adminListDiv = document.getElementById('adminList');
  imgViewer = document.getElementById('imgViewer');
  viewerImg = document.getElementById('viewerImg');
  viewerPrev = document.getElementById('viewerPrev');
  viewerNext = document.getElementById('viewerNext');
  viewerClose = document.getElementById('viewerClose');
  orderSticker = document.getElementById('orderSticker');
  stickerCountEl = document.getElementById('stickerCount');
  buyBtn = document.getElementById('buyBtn');
  buyBtnIndicator = document.getElementById('buyBtnIndicator');
  saveOrderBtn = document.getElementById('saveOrderBtn');
  clearCartBtn = document.getElementById('clearCartBtn');
  navHome = document.getElementById('nav-home');
  navOffers = document.getElementById('nav-offers');
  navAdmin = document.getElementById('nav-admin');
  closeCartBtn = document.getElementById('closeCartBtn');
  adminLoginBtn = document.getElementById('adminLoginBtn');
  submitProductBtn = document.getElementById('submitProductBtn');

  // ربط الأحداث
  navHome.addEventListener('click', (e)=>{ e.preventDefault(); showSection('home'); });
  navOffers.addEventListener('click', (e)=>{ e.preventDefault(); showSection('offers'); });
  navAdmin.addEventListener('click', (e)=>{ e.preventDefault(); openAdminModal(); });

  orderSticker.addEventListener('click', ()=> openSideCart());
  closeCartBtn.addEventListener('click', ()=> closeSideCart());

  viewerPrev.addEventListener('click', ()=> {
    if(viewerImgs.length===0) return;
    viewerIndex = (viewerIndex-1+viewerImgs.length) % viewerImgs.length;
    changeViewerImg(viewerImgs[viewerIndex]);
  });
  viewerNext.addEventListener('click', ()=> {
    if(viewerImgs.length===0) return;
    viewerIndex = (viewerIndex+1) % viewerImgs.length;
    changeViewerImg(viewerImgs[viewerIndex]);
  });
  viewerClose.addEventListener('click', closeViewer);
  imgViewer.addEventListener('click', e=> { if(e.target === imgViewer) closeViewer(); });

  buyBtn.addEventListener('click', function(){
    if(cart.length === 0){ alert('السلة فارغة'); return; }
    let text = "مرحبًا، أود تقديم طلب شراء:\n";
    text += "---------------------\n";
    text += "المنتجات المطلوبة:\n";
    let total = 0;
    cart.forEach((ci, idx) => {
      const p = products.find(x => x.id == ci.id);
      if(!p) return;
      text += `${idx + 1}. ${p.name} × ${ci.qty} = ${formatCurrency((Number(p.price)||0) * ci.qty)} ريال عماني\n`;
      total += (Number(p.price)||0) * ci.qty;
    });
    text += "---------------------\n";
    text += `المجموع الكلي: ${formatCurrency(total)} ريال عماني\n\n`;
    text += "يرجى تأكيد الطلب أو التواصل لأي استفسار. شكرًا لكم!";
    window.open(`https://wa.me/77324648?text=${encodeURIComponent(text)}`, '_blank');
  });

  clearCartBtn.addEventListener('click', ()=>{
    if(!confirm('هل تريد تفريغ السلة؟')) return;
    cart = [];
    saveCart();
    renderCartViews();
  });
  saveOrderBtn.addEventListener('click', saveOrderToSupabase);

  adminLoginBtn.addEventListener('click', ()=> {
    const pass = document.getElementById('adminPass').value;
    if(pass === ADMIN_PASS){
      sessionStorage.setItem('adminAuth','true');
      loginPanel.style.display = 'none';
      controlPanel.style.display = 'block';
      loadAdminList();
    }else{
      alert('كلمة المرور خاطئة');
    }
  });
  submitProductBtn.addEventListener('click', submitProduct);

  // init
  fetchProductsFromSupabase();
  const h = window.location.hash || '#home';
  if(h === '#offers') showSection('offers'); else showSection('home');
  updateSticker(false);
});

/* مفتاح Escape لغلق المودال وعارض الصور */
document.addEventListener('keydown', function(e){
  if(e.key === 'Escape'){
    if(imgViewer && imgViewer.style.display === 'flex') closeViewer();
    if(adminModal && adminModal.style.display === 'flex') closeAdmin();
  }
});
</script>
</body>
</html>